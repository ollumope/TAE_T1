---
title: "Agrupamientos de los barrios de Medellín"
author: "Santiago Arboleda Quiroz, Olga Lucía Montoya Pérez, Alberto Ramirez Velasquez, Juan David Tangarife Patino"
date: "Semestre 02-2019"
---

En este trabajo se abordará el problema de agrupar los barrios de Medellín de acuerdo a distintas dimensiones y
analizar espacialmente las agrupaciones.

**Dimensión Vivienda y Servicios Públicos**

La dimensión de vivienda y servicios públicos miden dentro de la encuesta de calidad de vida como viven los Medellinenses, en que condiciones estan sus hogares a nivel de tipo de vivienda y sus características físicas: material de paredes y pisos,t enencia y financiación de la vivienda: tipo de tenencia de la vivienda; tenencia de escritura de propiedad; subsidios recibidos para la compra, construcción, mejora, titulación o escrituración de la vivienda

Para la el análisis de la dimensión de VIVIENDA Y SERVICIOS PUBLICOS en los barrios de Medellín se toman las siguientes preguntas con sus respectivos indicadores:

* P_12 - Cuántas personas componen este hogar?
  * Indicador: Promedio de personas por hogar
  * Fórmula: Número de personas en cada hogar / Número total de hogares

* P_26 - Por qué causa Principalmente se vino a vivir a este municipio?
 * Indicador: Porcentaje de hogares por barrio que han llegado por problemas de orden público
 * Fórmula: Cantidad de hogares que llegaron al barrio por problemas de orden público / Número total de hogares
 
* P_30 - ¿Cuánto hace que vive en ESTE BARRIO o VEREDA? En años
 * Indicador_1: Porcentaje de familias que han vivo en el barrio o vereda por más de 6 años
 * Fórmula: Cantidad de hogares que llevan viviendo en el barrio o vereda más de 6 años / Número total de hogares
 * Indicador_2: Tiempo promedio de permanencia de las personas en el barrio
 * Fórmula: Sumatoria de los tiempos de permanencia de las personas en el barrio / Número total de hogares

* P_146 - Tipo de Vivienda
 * Indicador_1: Porcentaje de hogares del barrio que viven en Rancho o vivienda de desechos (1)
 * Indicador_2: Porcentaje de hogares del barrio que viven en Cuarto(s) (2)
 * Indicador_3: Porcentaje de hogares del barrio que viven en Cuartos en inquilinato (3)
 * Indicador_4: Porcentaje de hogares del barrio que viven en Apartamento (4)
 * Indicador_5: Porcentaje de hogares del barrio que viven en Casa (5)
 * Fórmula: Cantidad de hogares que viven en .... / Número total de hogares


* P_149 - ¿De dónde obtiene principalmente esta vivienda el agua para consumo humano?
 * Indicador: Porcentaje de hogares que toman el agua de entidades prestadoras de servicios públicos domiciliarios (1)
 * Fórmula: Cantidad de hogares que toman el agua de entidades prestadoras de servicios públicos domiciliarios / Número total de hogares

* P_158 - La unidad de vivienda cuenta con servicios públicos de Energía (1)
  P_162 - La unidad de vivienda cuenta con servicios públicos de Acueducto (1)
  P_165 - La unidad de vivienda cuenta con servicios públicos de Alcantarillado (1)
  P_174 - La unidad de vivienda cuenta con servicios públicos de Aseo (recolección) (1)
  * Indicador: Porcentaje de hogares con acceso a almenos uno de los servicios públicos básicos
  * Fórmula: Cantidad de hogares con acceso al menos uno de los servicios públicos básicos / Número total de hogares
  
* P_160 - La unidad de vivienda cuenta con servicios públicos de Estado Suspendido Energía (1)
  P_164 - La unidad de vivienda cuenta con servicios públicos de Estado Suspendido Acueducto (1)
  P_173 - La unidad de vivienda cuenta con servicios públicos de Estado Suspendido Gas Natural (1)
  P_169 -	La unidad de vivienda cuenta con servicios públicos de Estado Suspendido Telefono (línea fija) (1)
  P_180 -	La unidad de vivienda cuenta con servicios públicos de Estado Suspendido Internet (1)
  * Indicador: Porcentaje de hogares en el momento de la encuesta con algún servicios públicos suspendido (1)
  * Fórmula: Número de hogares con algún servicios públicos suspendido / Número total de hogares
  
* P_178 - La unidad de vivienda cuenta con servicios públicos de Conexión a Internet
  * Indicador: Porcentaje de hogares con servicios públicos de Conexión a Internet (1) 
  * Fórmula: Número de hogares con con servicios públicos de Conexión a Internet / Número total de hogares
  
* P_226 - La vivienda ocupada por este hogar es?
 * Indicador_1: Porcentaje de hogares en arriendo o subarriendo mensual (1) 
 * Indicador_2: Porcentaje de hogares en propia (2,3) 
 * Indicador_3: Porcentaje de hogares en otras condiciones (4,5,6) 
 * Fórmula: Número de hogares ocupadas bajo la caracteristicas de cada uno de los indicadores / Número total de hogares
 
El insumo principal de este trabajo son los datos abiertos del portal Medata y en particular la Encuesta de Calidad de Vida Medellín Cómo vamos.
```{r}
ECV <- read.csv("./dataSet/encuesta_calidad_vida.csv", header = TRUE, sep=";")
```

Definiciones:

Cuando las preguntas hacen referencia a nivel de hogar, tomaremos la moda como referencia, es decir, el valor más representativo en las respuestas obtenidas en ese hogar. La proporción se hará sobre el total de los encuestados.


Librerias a utilizar en el desarrollo del proyecto
```{r}
#library(xlsx)
library("factoextra")
library(cluster)
library(plyr)
library(ggplot2)
library(GGally)
library(dplyr)
library(magrittr)
library('sqldf')
library(rgdal)
library(leaflet)
```

Función que permite sacar la moda para las preguntas orientadas a hogares
```{r}
getmode <- function(v) {
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
}
```

Se procede a normalizar las cabeceras del dataframe del set de datos
```{r}
names_ECV <- names(ECV)
i = 1
l_names <- list()
for (name_col in names_ECV) {
    str_col <- unlist(strsplit(name_col," "))
    str_col <- unlist(strsplit(str_col,"[.]"))
    if (length(str_col) > 2){
        l_names[i] <- paste(str_col[2],str_col[3],sep = '_')    
    }
    else
    {
        l_names[i] <- paste(str_col[2])   
    }

    i = i + 1
}

ECV <- setNames(ECV,l_names)
```

1. Caracterización de las dimensiones para la dimensión VIVIENDA Y SERVICIOS PUBLICOS

```{r}
summary(ECV)
```


```{r}
ECV_VIVIENDA <- ECV[,c("encuesta","persona","comuna","barrio","estrato","p_1","p_12","p_26","p_30","p_146",
                       "p_149","p_158","p_160","p_162","p_164","p_165","p_169","p_173","p_174","p_178","p_180","p_226")]
```

No existen valores nulos dentro de las preguntas de vivienda 
```{r}
summary(ECV_VIVIENDA)
```

Se procede a realizar el cálculo de cada uno de los indicadores definidos para la dimensión Vivienda y 

Cálculo P_12. Promedio de personas por hogar

```{r}
#Se toma el máximo número de integrantes por encuesta
ECV_VIVIENDA_BARRIO <-ECV_VIVIENDA %>% select(encuesta,comuna, barrio,p_12) %>% 
                      group_by(encuesta, comuna, barrio) %>% 
                      summarise(total = n_distinct(encuesta),p_12 = max(p_12)) %>% ungroup() %>% 
                      group_by(comuna,barrio) %>% summarise(total = sum(total), p_12 = sum(p_12) / sum(total)) %>%   ungroup() 
#write.xlsx(ECV_VIVIENDA[ECV_VIVIENDA$barrio == 'AGUAS FRÍAS',], 'aguasfrias2.xlsx') 
```

Cálculo P_26. Porcentaje de hogares por barrio que han llegado por problemas de orden público

```{r}
#ECV_VIVIENDA[,c("p_26")]
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_26 == 1,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_26 = min(p_26)) %>% ungroup() %>%
       group_by(comuna,barrio) %>% summarise(p_26 = sum(p_26)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_26 <- ECV_VIVIENDA_BARRIO$p_26 / ECV_VIVIENDA_BARRIO$total
```

Cálculo P_30. Porcentaje de familias que han vivo en el barrio o vereda por más de 6 años

```{r}
ECV_VIVIENDA$p_antiguedad <- ifelse(ECV_VIVIENDA$p_30 >= 0 & ECV_VIVIENDA$p_30 <= 5, 1, ifelse(ECV_VIVIENDA$p_30 < 0, 0, 2))
# 1 menos de 5 años, 0 No sabe, 2 más de 6 años

tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_antiguedad == 2,] %>% 
       group_by(encuesta, comuna ,barrio) %>% summarise(p_30 = n_distinct(p_antiguedad)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_30 = sum(p_30)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_30 <- ECV_VIVIENDA_BARRIO$p_30 / ECV_VIVIENDA_BARRIO$total 
```

*Cálculo P_146_1. Porcentaje de hogares del barrio que viven en Rancho o vivienda de desechos*

```{r}
#ECV_VIVIENDA[ECV_VIVIENDA$p_146 == 1,]
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_146 == 1,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_146 = n_distinct(p_146)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_146 = sum(p_146)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_146 <- ECV_VIVIENDA_BARRIO$p_146 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_146'] <- 'p_146_1'
```

*Cálculo P_146_2. Porcentaje de hogares del barrio que viven en Cuarto(s)*

```{r}
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_146 == 2,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_146 = n_distinct(p_146)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_146 = sum(p_146)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_146 <- ECV_VIVIENDA_BARRIO$p_146 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_146'] <- 'p_146_2'
```

*Cálculo P_146_3. Porcentaje de hogares del barrio que viven en Cuartos en inquilinato*

```{r}
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_146 == 3,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_146 = n_distinct(p_146)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_146 = sum(p_146)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_146 <- ECV_VIVIENDA_BARRIO$p_146 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_146'] <- 'p_146_3'
```

*Cálculo P_146_4. Porcentaje de hogares del barrio que viven en Apartamento*

```{r}
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_146 == 4,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_146 = n_distinct(p_146)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_146 = sum(p_146)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_146 <- ECV_VIVIENDA_BARRIO$p_146 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_146'] <- 'p_146_4'
```

*Cálculo P_146_5. Porcentaje de hogares del barrio que viven en Casa*

```{r}
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_146 == 5,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_146 = n_distinct(p_146)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_146 = sum(p_146)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE) 

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_146 <- ECV_VIVIENDA_BARRIO$p_146 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_146'] <- 'p_146_5'
```

Cálculo P_149. Porcentaje de hogares que toman el agua de entidades prestadoras de servicios p?blicos domiciliarios

```{r}
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_149 == 1,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_149 = getmode(p_149)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_149 = sum(p_149)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE) 

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_149 <- ECV_VIVIENDA_BARRIO$p_149 / ECV_VIVIENDA_BARRIO$total 
```

Cálculo Servicios Públicos Básicos (P_158, P_162, P_165, P_174)

```{r}
ECV_VIVIENDA$p_SP <- ifelse(ECV_VIVIENDA$p_158 == 1 & ECV_VIVIENDA$p_162 == 1 & ECV_VIVIENDA$p_165 == 1
                          & ECV_VIVIENDA$p_174 == 1, 1, 0)

tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_SP == 1,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_SP = getmode(p_SP)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_SP = sum(p_SP)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_SP <- ECV_VIVIENDA_BARRIO$p_SP / ECV_VIVIENDA_BARRIO$total
```

Cálculo Servicios Públicos Suspendidos (P_160, P_164, P_173, P_169, P_180)

```{r}
ECV_VIVIENDA$p_SPS <- ifelse(ECV_VIVIENDA$p_160 == 1 | ECV_VIVIENDA$p_164 == 1 | ECV_VIVIENDA$p_173 == 1
                          | ECV_VIVIENDA$p_169 == 1 | ECV_VIVIENDA$p_180 == 1, 1, 0)

tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_SPS == 1,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_SPS = getmode(p_SPS)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_SPS = sum(p_SPS)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_SPS <- ECV_VIVIENDA_BARRIO$p_SPS / ECV_VIVIENDA_BARRIO$total
```

Cálculo P_178. Porcentaje de hogares con servicios públicos de Conexión a Internet

```{r}
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_178 == 1,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_178 = min(p_178)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_178 = sum(p_178)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_178 <- ECV_VIVIENDA_BARRIO$p_178 / ECV_VIVIENDA_BARRIO$total
```

*P_226_1. Porcentaje de hogares en arriendo o subarriendo mensual*

```{r}
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_226 == 1,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_226 = n_distinct(encuesta)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_226 = sum(p_226)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_226 <- ECV_VIVIENDA_BARRIO$p_226 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_226'] <- 'p_226_1'
```

*P_226_2. Porcentaje de hogares con propia*

```{r}
tmp <- subset(ECV_VIVIENDA, p_226 == 2 | p_226 == 3) %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_226 = n_distinct(encuesta)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_226 = sum(p_226)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE) 

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_226 <- ECV_VIVIENDA_BARRIO$p_226 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_226'] <- 'p_226_2'
```

*P_226_3. Porcentaje de hogares en otras condiciones*

```{r}
tmp <- subset(ECV_VIVIENDA, p_226 == 4 | p_226 == 5 | p_226 == 6) %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_226 = n_distinct(encuesta)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_226 = sum(p_226)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE) 

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_226 <- ECV_VIVIENDA_BARRIO$p_226 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_226'] <- 'p_226_3'
```

Depuración de columnas

```{r}
ECV_VIVIENDA_BARRIO$total <- NULL
```

**Dimensión Salud**


La dimensión de salud mide que tan informados se encuentran las Medellinenses sobre los métodos de planificación familiar y que tanto hacen uso del sistema de salud de la ciudad.


```{r}
ECV_SALUD <- ECV[,c("encuesta","persona","comuna","barrio","estrato","p_15","p_307","p_308","p_324","p_325","p_326","p_327")]
```

!!!!Existen valores nulos!!!!!
```{r}
summary(ECV_SALUD)
```

Para la el análisis de la dimensión de SALUD en los barrios de Medellín se toman las siguientes preguntas con sus respectivos indicadores:

* P_307 - ¿Considera que tiene suficiente información acerca de los métodos de planificación familiar?
 * Indicador: Porcentaje de personas que consideran que tienen suficiente información sobre los métodos de planificación familiar
 * Fórmula: Cantidad de personas que consideran que tienen suficiente información sobre los métodos de planificación familiar / Total de personas encuestadas

P_308 - ¿Usted planifica?
 * Indicador: Porcentaje de mujeres que planifican (2)	
 * Fórmula: Cantidad de mujeres que planifican / Total de mujeres encuestadas

P_324 - ¿En los últimos 30 días, tuvo alguna enfermedad, accidente, problema odontológico, o algún otro problema de salud que no haya implicado hospitalización?
 * Indicador: Porcentaje de personas que en los últimos 30 días han tenido algún problema de salud y no haya necesitado hospitalización
 * Fórmula: Cantidad de personas que en los últimos 30 días han tenido algún problema de salud y no haya necesitado hospitalización / Total de personas encuestadas

P_325 - ¿Para tratar ese problema de salud, que hizo principalmente?
 * Indicador: 
 * Fórmula:
 
P_326 - ¿Cuál fue la principal razón por la que no solicitó o no recibió atención por el problema de salud?
 * Indicador: 
 * Fórmula:
 
P_327 - En los últimos 12 meses (en caso de no haberlos utilizado ponga (0) Utilizó los servicios de promoción y prevención
 * Indicador:
 * Fórmula:
 
Cálculo Número total de encuestados
```{r}
ECV_SALUD_BARRIO <- ECV_SALUD %>% select(encuesta,barrio,persona) %>% 
                    group_by(encuesta, barrio) %>% 
                    summarise(total = max(persona)) %>% ungroup() %>% 
                    group_by(barrio) %>% summarise(total = sum(total)) %>% ungroup()
```

Cálculo P_307

```{r}
tmp <- ECV_SALUD[ECV_SALUD$p_307 == 1,] %>% 
       group_by(encuesta, barrio) %>% summarise(p_307 = sum(p_307)) %>% ungroup() %>%
       group_by(barrio) %>% summarise(p_307 = sum(p_307)) %>% ungroup()

ECV_SALUD_BARRIO <- merge(x=ECV_SALUD_BARRIO,y=tmp,by="barrio",all.x=TRUE) 

if(exists('tmp')) rm(tmp)

ECV_SALUD_BARRIO$p_307 <- ECV_SALUD_BARRIO$p_307 / ECV_SALUD_BARRIO$total
```

```{r}
#write.xlsx(ECV_SALUD[ECV_SALUD$barrio == 'AGUAS FRÍAS',], 'aguasfrias.xlsx')
```

Cálculo Número total de mujeres encuestadas

```{r}
tmp <- ECV_SALUD[ECV_SALUD$p_15 == 2,] %>% select(encuesta,barrio,persona) %>% 
       group_by(encuesta, barrio) %>% summarise(total_mujer = n_distinct(persona)) %>% ungroup() %>% 
       group_by(barrio) %>% summarise(total_mujer = sum(total_mujer)) %>% ungroup()

ECV_SALUD_BARRIO <- merge(x=ECV_SALUD_BARRIO,y=tmp,by="barrio",all.x=TRUE) 

if(exists('tmp')) rm(tmp)

```

Cálculo P_308

```{r}
tmp <- subset(ECV_SALUD, p_15 == 2 & p_308 == 1) %>% select(encuesta,barrio,persona) %>% 
       group_by(encuesta, barrio) %>% summarise(p_308 = max(persona)) %>% ungroup() %>% 
       group_by(barrio) %>% summarise(p_308 = sum(p_308)) %>% ungroup()

ECV_SALUD_BARRIO <- merge(x=ECV_SALUD_BARRIO,y=tmp,by="barrio",all.x=TRUE) 

if(exists('tmp')) rm(tmp)

ECV_SALUD_BARRIO$p_308 <- ECV_SALUD_BARRIO$p_308 / ECV_SALUD_BARRIO$total_mujer
```

Cálculo P_324 (1)

```{r}
tmp <- ECV_SALUD[ECV_SALUD$p_324 == 1,] %>% 
         group_by(encuesta, barrio)  %>% summarise(p_324 = max(persona)) %>% ungroup() %>%
         group_by(barrio) %>% summarise(p_324 = sum(p_324)) %>% ungroup()

ECV_SALUD_BARRIO <- merge(x=ECV_SALUD_BARRIO,y=tmp,by="barrio",all.x=TRUE) 

if(exists('tmp')) rm(tmp)

ECV_SALUD_BARRIO$p_324 <- ECV_SALUD_BARRIO$p_324 / ECV_SALUD_BARRIO$total
```

Depuración de columnas

```{r}
ECV_SALUD_BARRIO$total <- NULL
ECV_SALUD_BARRIO$total_mujer <- NULL
```

**Estadisticas básicas VIVIENDA**

```{r}
summary(ECV_VIVIENDA_BARRIO)
```

**Agrupamientos**

- Imputación de los valores Nulos - 

Para efectos de la ejecución de los modelos, los valores del data frame ECV_VIVIENDA_BARRIO que sean nulos se llenan con 0 dado que cuando se presenta un valor NAN significa que el indicador no aplica para el barrio y el cero lo representa
```{r}
ECV_VIVIENDA_BARRIO[is.na(ECV_VIVIENDA_BARRIO)] <- 0
```

- Normalización de los datos - 

Si bien, la mayoria de los indicadores del dataframe ECV_VIVIENDA_BARRIO se encuentran en función de hogares existe un indicador en función de personas del hogar, por lo tanto es necesario poner todos los indicadores en la misma escala
```{r}
#Kmeans no acepta variables categoricas, el identificador del barrio se convierte en nombre de filas para que no sean consideras por el algoritmo
#ECV_VIVIENDA_BARRIO_SCALE <- tibble::column_to_rownames(ECV_VIVIENDA_BARRIO, var = c("comuna","barrio"))

#ECV_VIVIENDA_BARRIO_SCALE <- scale(ECV_VIVIENDA_BARRIO_SCALE)

#ECV_VIVIENDA_BARRIO_SCALE <- ECV_VIVIENDA_BARRIO %>% mutate_if(is.numeric,scale)
```
```{r}
ECV_VIVIENDA_BARRIO_CP <- ECV_VIVIENDA_BARRIO
ECV_VIVIENDA_BARRIO_CP$barrio <- paste(ECV_VIVIENDA_BARRIO_CP$comuna,ECV_VIVIENDA_BARRIO_CP$barrio,sep = "-")
ECV_VIVIENDA_BARRIO_CP$comuna <- NULL

ECV_VIVIENDA_BARRIO_SCALE <- tibble::column_to_rownames(ECV_VIVIENDA_BARRIO_CP, var = "barrio")

```


```{r}
any(is.na(ECV_VIVIENDA_BARRIO_SCALE))
any(is.finite(ECV_VIVIENDA_BARRIO_SCALE))
```

Se utilizan el diferentes métodos para determinar el k óptimo del algoritmo de clusterización Kmeans


Método del codo 

```{r}
fviz_nbclust(ECV_VIVIENDA_BARRIO_SCALE, kmeans, method = "wss") + labs(title= "Número óptimo de Clusters") + xlab("Número de Cluster (K)") 
```
De acuerdo a la gráfica donde se da el cambio de pendiente más significativo es en el k = 7

Diferencia entre los errores generados con diferentes k

```{r}
SS <- fviz_nbclust(ECV_VIVIENDA_BARRIO_SCALE, kmeans, method = "wss")
plot(2:10,diff(SS$data$y), type = "h", main="Diferencia en errores", xlab="k", ylab="diff") 
```

Método de la siluetta 

```{r}
fviz_nbclust(ECV_VIVIENDA_BARRIO_SCALE, kmeans, method = "silhouette")
```

De acuerdo a las gráficas de los diferentes metodos, se concluye que k = 3, es el k óptimo para la dimensión vivienda, por lo cual aplicaremos el algoritmo Kmeans con dicho valor de k 

```{r}
#[,2:9]
set.seed(1988)
kmeans_model <- kmeans(ECV_VIVIENDA_BARRIO[,3:15], 3, nstart = 50)
kmeans_model
```
El modelo da un ajuste del 60.4% con k = 3, el número de k óptimo tomado de la gráfica del codo y de la silueta 

Agregar el cluster a la data original
```{r}
df_member <- cbind(ECV_VIVIENDA_BARRIO, cluster = kmeans_model$cluster)
head(df_member)
```

Visualización de los grupos
```{r}
fviz_cluster(kmeans_model, data = ECV_VIVIENDA_BARRIO_SCALE, ellipse.type = "norm") + ggtitle("Distribución de los barrios en los clusters")

```
Recordemos las indicadores asociados a la dimensión VIVIENDA

* P_12 - Promedio de personas por hogar
* P_26 - Porcentaje de hogares por barrio que han llegado por problemas de orden público
* P_30 - Porcentaje de familias que han vivo en el barrio o vereda por más de 6 años
* P_146_1 - Porcentaje de hogares del barrio que viven en Rancho o vivienda de desechos
* P_146_2 - Porcentaje de hogares del barrio que viven en Cuarto(s) 
* P_146_3 - Porcentaje de hogares del barrio que viven en Cuartos en inquilinato
* P_146_4 - Porcentaje de hogares del barrio que viven en Apartamento
* P_146_5 - Porcentaje de hogares del barrio que viven en Casa
* P_149 - Porcentaje de hogares que toman el agua de entidades prestadoras de servicios públicos domiciliarios 
* P_158 - Porcentaje de hogares con acceso a almenos uno de los servicios públicos básicos
* P_160 - Porcentaje de hogares en el momento de la encuesta con algún servicios públicos suspendido
* P_178 - Porcentaje de hogares con servicios públicos de Conexión a Internet
* P_226_1 - Porcentaje de hogares en arriendo o subarriendo mensual
* P_226_2 - Porcentaje de hogares en propia (2,3) 
* P_226_3 - Porcentaje de hogares en otras condiciones (4,5,6)

```{r}
df_member[order(df_member$cluster),]
```
Análisis para cada uno de los grupos

*Grupo 1*

```{r}
summary(df_member[df_member$cluster == 1,])
```

En promedio hay 2.9 habitantes por hogar en los barrios de este grupo, este grupo de barrios dentro de su población tiene en promedio un 2% de hogares que han llegado  por problemas de orden público, el 65% de los hogares llevan m?s de 6 a?os viviendo en estos barrios y viven mayormente en apartamento, casi siempre propio o arrendado, en donde el agua es tomada de las entidades prestaras de servicios p?blicos y cuenta con acceso a los servicios p?blicos b?sicos. Al menos el 70% de los apartamentos cuentan con acceso a internet. 

*Grupo 2*
```{r}
df_member[df_member$cluster == 2,]
```
Barrios con promedio de 4 personas por hogar, al menos el 70% de los hogares han vivido all? por m?s de 6 a?os en sus casas o apartamentos arrendados o propios, cuantan con los servicios p?blicos b?sicos, solo el 9% de ellos tienen suspendido alguno de los servicios , menos del 45% de los hogares de este grupo no tienen internet. 8% de los hogares de este barrio han llegado al sector por problemas de orden p?blico.

*Grupo 3*
```{r}
summary(df_member[df_member$cluster == 3,])
```

Barrios donde predominan las casas, el 80% de los hogares viven en casas, con un promedio de 3.5 habitantes por hogar, sus propiedades en m?s del 60% son propias, no todos los hogares toman el agua de las entidades prestadoras de servicios p?blicos y al menos el 54% de los hogares tienen acceso a los servicios p?blicos b?sicos, muy pocos (6%) de los que tienen acceso a los servicios p?blicos lo tienen suspendido. Solo el 27% de los hogares tienen acceso a internet 


An?lisis general de los grupos de acuerdo a las preguntas con mayor incidencia en la Encuesta de Calidad de Vida de Medell?n

```{r}
df_member %>% select(p_12,cluster) %>% group_by(cluster) %>% summarise(p_12 = mean(p_12)) %>% ungroup() %>% ggplot(aes(x = "", y = p_12, fill = cluster)) + geom_bar(width = 1, stat = "identity") + coord_polar("y", start = 0) + geom_text(aes(label = round(p_12)), position = position_stack(vjust = 0.5)) + labs(x = NULL, y = NULL, fill = NULL, title = "Promedio de personas por hogar") + theme_classic() + theme(axis.line = element_blank(),axis.text = element_blank(), axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5, color = "#666666"))
```

```{r}
df_member %>% select(p_146_4,cluster) %>% group_by(cluster) %>% summarise(p_146_4 = mean(p_146_4)) %>% ungroup() %>% ggplot(aes(x = "", y = p_146_4, fill = cluster)) + geom_bar(width = 1, stat = "identity") + coord_polar("y", start = 0) + geom_text(aes(label =  paste0(round(p_146_4*100), "%")), position = position_stack(vjust = 0.5)) + labs(x = NULL, y = NULL, fill = NULL, title = "Hogares que viven en aptos") + theme_classic() + theme(axis.line = element_blank(),axis.text = element_blank(), axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5, color = "#666666"))
```

```{r}
df_member %>% select(p_146_5,cluster) %>% group_by(cluster) %>% summarise(p_146_5 = mean(p_146_5)) %>% ungroup() %>% ggplot(aes(x = "", y = p_146_5, fill = cluster)) + geom_bar(width = 1, stat = "identity") + coord_polar("y", start = 0) + geom_text(aes(label =  paste0(round(p_146_5*100), "%")), position = position_stack(vjust = 0.5)) + labs(x = NULL, y = NULL, fill = NULL, title = "Hogares que viven en casas") + theme_classic() + theme(axis.line = element_blank(),axis.text = element_blank(), axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5, color = "#666666"))
```

```{r}
df_member %>% select(p_149,cluster) %>% group_by(cluster) %>% summarise(p_149 = mean(p_149)) %>% ungroup() %>% ggplot(aes(x = "", y = p_149, fill = cluster)) + geom_bar(width = 1, stat = "identity") + coord_polar("y", start = 0) + geom_text(aes(label =  paste0(round(p_149*100), "%")), position = position_stack(vjust = 0.5)) + labs(x = NULL, y = NULL, fill = NULL, title = "Hogares con agua desde servicios p?blicos") + theme_classic() + theme(axis.line = element_blank(),axis.text = element_blank(), axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5, color = "#666666"))
```

```{r}
df_member %>% select(p_SP,cluster) %>% group_by(cluster) %>% summarise(p_SP = mean(p_SP)) %>% ungroup() %>% ggplot(aes(x = "", y = p_SP, fill = cluster)) + geom_bar(width = 1, stat = "identity") + coord_polar("y", start = 0) + geom_text(aes(label =  paste0(round(p_SP*100), "%")), position = position_stack(vjust = 0.5)) + labs(x = NULL, y = NULL, fill = NULL, title = "Hogares con servicios p?blicos b?sicos") + theme_classic() + theme(axis.line = element_blank(),axis.text = element_blank(), axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5, color = "#666666"))
```
```{r}
df_member %>% select(p_178,cluster) %>% group_by(cluster) %>% summarise(p_178 = mean(p_178)) %>% ungroup() %>% ggplot(aes(x = "", y = p_178, fill = cluster)) + geom_bar(width = 1, stat = "identity") + coord_polar("y", start = 0) + geom_text(aes(label =  paste0(round(p_178*100), "%")), position = position_stack(vjust = 0.5)) + labs(x = NULL, y = NULL, fill = NULL, title = "Hogares con acceso a internet") + theme_classic() + theme(axis.line = element_blank(),axis.text = element_blank(), axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5, color = "#666666"))
```

```{r}
df_member %>% select(p_226_1,cluster) %>% group_by(cluster) %>% summarise(p_226_1 = mean(p_226_1)) %>% ungroup() %>% ggplot(aes(x = "", y = p_226_1, fill = cluster)) + geom_bar(width = 1, stat = "identity") + coord_polar("y", start = 0) + geom_text(aes(label =  paste0(round(p_226_1*100), "%")), position = position_stack(vjust = 0.5)) + labs(x = NULL, y = NULL, fill = NULL, title = "Hogares en arriendo o subarriendo") + theme_classic() + theme(axis.line = element_blank(),axis.text = element_blank(), axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5, color = "#666666"))
```
```{r}
df_member %>% select(p_226_2,cluster) %>% group_by(cluster) %>% summarise(p_226_2 = mean(p_226_2)) %>% ungroup() %>% ggplot(aes(x = "", y = p_226_2, fill = cluster)) + geom_bar(width = 1, stat = "identity") + coord_polar("y", start = 0) + geom_text(aes(label =  paste0(round(p_226_2*100), "%")), position = position_stack(vjust = 0.5)) + labs(x = NULL, y = NULL, fill = NULL, title = "Hogares con casa propia") + theme_classic() + theme(axis.line = element_blank(),axis.text = element_blank(), axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5, color = "#666666"))
```

```{r}
df_member %>% select(p_226_3,cluster) %>% group_by(cluster) %>% summarise(p_226_3 = mean(p_226_3)) %>% ungroup() %>% ggplot(aes(x = "", y = p_226_3, fill = cluster)) + geom_bar(width = 1, stat = "identity") + coord_polar("y", start = 0) + geom_text(aes(label =  paste0(round(p_226_3*100), "%")), position = position_stack(vjust = 0.5)) + labs(x = NULL, y = NULL, fill = NULL, title = "Hogares que no estan arrendados con propiedad") + theme_classic() + theme(axis.line = element_blank(),axis.text = element_blank(), axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5, color = "#666666"))
```

Caracteristicas que distinguen un grupo de barrios de otro

 - Grupo 1: se caracterizan por tener menos personas por hogar, viven mayormente en apartamentos propios con acceso a los servicios p?blicos b?sicos e internet 
 
 - Grupo 2: se caracterizan por combinar sus viviendas entre apartamentos y casas
 
 - Grupo 3: se caracterizan por vivir mayoremente en casas propias, el acceso al agua proviene principalmente de otros medios diferentes a las entidades prestadoras de servicios y la gran mayor?a de la poblaci?n no cuenta con servicios p?blicos basicos ni internet 

3. Análisis espacial 

```{r}
barrios_med = readOGR("./dataSet/Barrio_Vereda/Barrio_Vereda.shp",layer="Barrio_Vereda")
```
```{r}
print(barrios_med@data$NOMBRE)
```

```{r}
map = leaflet(barrios_med)
map = addTiles(map)
map = addTiles(map)
colores = sample(x=~cluster, size = length(barrios_med), replace=TRUE)
map = addPolygons(map, popup = barrios_med, color = colores, addMarkers(popup = ~cluster))
map
```

```{r}
df_member <- df_member[,-1]
```

```{r}
prueba <- df_member %>% select(barrio, cluster)
```


```{r}
barrios <- read.csv("./dataSet/Barrio_Vereda.csv", header = TRUE, sep=",")
```

```{r}
barrios$NOMBRE <- toupper(barrios$NOMBRE)
```


```{r}
nom_bar <- merge(x = barrios_med, y = prueba, by.x="NOMBRE", by.y="barrio", all.x = TRUE)


```

```{r}
bins <- c(0, 10, 20)
pal <- colorBin("YlOrRd", domain = barrios_med$cluster, bins = bins)

m %>% addPolygons(
  fillColor = ~pal(cluster),
  weight = 2,
  opacity = 1,
  color = "white",
  dashArray = "2",
  fillOpacity = 0.7,
  highlight = highlightOptions(
      weight = 5,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE),
    #label = labels,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto")) %>%
  addLegend(pal = pal, values = ~cluster, opacity = 0.7, title = NULL,
    position = "bottomright")

```








