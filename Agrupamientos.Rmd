---
title: "Agrupamientos de los barrios de Medellín"
author: "Santiago Arboleda Quiroz, Olga Lucía Montoya Pérez, Alberto Ramirez Velasquez, Juan David Tangarife Patino"
date: "Semestre 02-2019"
---

En este trabajo se abordará el problema de agrupar los barrios de Medellín de acuerdo a distintas dimensiones y
analizar espacialmente las agrupaciones.


funcion que me permite sacar la moda para las preguntas orientadas a hogares

```{r}
getmode <- function(v) {
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
}
```

El insumo principal de este trabajo son los datos abiertos del portal Medata y en particular la Encuesta de Calidad de Vida Medellín Cómo vamos.
```{r}
ECV <- read.csv("./dataSet/encuesta_calidad_vida.csv", header = TRUE, sep=";")
```

Se procede a normalizar las cabeceras del dataframe del set de datos
```{r}
names_ECV <- names(ECV)
i = 1
l_names <- list()
for (name_col in names_ECV) {
    str_col <- unlist(strsplit(name_col," "))
    str_col <- unlist(strsplit(str_col,"[.]"))
    if (length(str_col) > 2){
        l_names[i] <- paste(str_col[2],str_col[3],sep = '_')    
    }
    else
    {
        l_names[i] <- paste(str_col[2])   
    }

    i = i + 1
}

ECV <- setNames(ECV,l_names)
```

1. Caracterización de las dimensiones para la dimensión ALIMENTACION


```{r}
summary(ECV)
```

Para la dimensión de ALIMENTACION se toman las preguntas:
P_291 - En este hogar: En los ultimos 30 días, ¿Usted se preocupó alguna vez de que en su hogar se acabaran los alimentos debido a falta de dinero?
P_292 - En este hogar: En los ultimos 30 días, ¿Alguna vez en su hogar se quedaron sin dinero para obtener una P_295 - alimentación nutritiva:...?
En este hogar: En los ultimos 30 días, ¿Alguna vez en su hogar se quedaron sin alimentos por falta de dinero?


```{r}

ECV_ALIMENTO <- ECV[,c("encuesta","persona","comuna","barrio","p_1","p_291","p_292","p_295")]
ECV_BASICO <- ECV[,c("comuna","barrio","estrato")]
ECV_BASICO <- unique(ECV_BASICO)

```

Revisemos como es el comportamiento de los datos seleccionados
```{r}
summary(ECV_ALIMENTO)
```

Dado que para las preguntas seleccionas en la dimension de alimentación (291,292,295), no fueron contestadas por ningunos de los encuentados del mismo hogar, se descartan esas respuestas para el analisis

```{r}
ECV_ALIMENTO_DEP <- subset(ECV_ALIMENTO,p_291 != 'NULL' & p_292 != 'NULL' & p_295 != 'NULL')
nrow(ECV_ALIMENTO_DEP)
```
```{r}
summary(ECV_ALIMENTO_DEP)
```

Definiciones:

Cuando las preguntas hacen referencia a nivel de hogar, tomaremos la moda como referencia, es decir, el valor más representativo en las respuestas obtenidas en ese hogar. La proporción se hará sobre el total de los encuestados.


Las columnas de preguntas son de tipo caracter, es necesario convertirlas a enteros
```{r}
#ECV_ALIMENTO_DEP[c('p_291','p_292','p_295')] <- lapply(ECV_ALIMENTO_DEP[c('p_291','p_292','p_295')], as.integer)

#ECV_ALIMENTO_DEP$p_292 = as.numeric(ECV_ALIMENTO_DEP$p_292)

#transform(ECV_ALIMENTO_DEP, p_295 = as.numeric(p_295))

```
################################## propuesta Juan David ###################################

Dimensión Alimentación.
P_291: En este hogar: En los ultimos 30 días, ¿Usted se preocupó alguna vez de que en su hogar se acabaran los alimentos debido a falta de dinero?
Indicador: Porcentaje de personas que piensan que por falta dinero se acabaría los alimentos en su hogar
Formula: 
  Totales de personas SI / Totales Encuestados P_291
  Totales de personas NO / Totales Encuestados P_291
  
```{r}
library(plyr)
names(ECV_ALIMENTO_DEP)
```

```{r}
#separo un dataSet con la informacion importante para calcular el indicador
ECV_ALIMENTO_P291 <- ECV_ALIMENTO_DEP[,c("barrio","estrato","p_291")]
#Genero un conteo del toral de respuestas por barrio y estrato
ECV_ALIMENTO_P291_COUNTXR <- aggregate(ECV_ALIMENTO_P291$p_291,by=list(ECV_ALIMENTO_P291$barrio,ECV_ALIMENTO_P291$estrato,ECV_ALIMENTO_P291$p_291),function(x){NROW(x)})
ECV_ALIMENTO_P291_COUNTXR <- setNames(ECV_ALIMENTO_P291_COUNTXR,c("barrio",'estrato',"p_291","totalRespuestaE"))

#Genero un conteo del toral de respuestas por barrio 
ECV_ALIMENTO_P291_CTB <- aggregate(ECV_ALIMENTO_P291$p_291,by=list(ECV_ALIMENTO_P291$barrio),function(x){NROW(x)})
ECV_ALIMENTO_P291_CTB <- setNames(ECV_ALIMENTO_P291_CTB,c("barrio","TotalB"))

#Separo otro DataSet con el barrio, estrato y la cantidad de respuestas para calcular el total #encuestado
ECV_ALIMENTO_P291_COUNT <- ECV_ALIMENTO_P291_COUNTXR[,c("barrio","estrato","totalRespuestaE")]
ECV_ALIMENTO_P291_COUNT <- aggregate(ECV_ALIMENTO_P291_COUNTXR$totalRespuesta,by=list(ECV_ALIMENTO_P291_COUNTXR$barrio,ECV_ALIMENTO_P291_COUNTXR$estrato), FUN="sum")

ECV_ALIMENTO_P291_COUNT <- setNames(ECV_ALIMENTO_P291_COUNT,c("barrio","estrato","totalEncuestadosE"))
# se cuenta con 2 dataSet para generar el indicador k_p295
ECV_ALIMENTO_P291_K291 <- merge(x=ECV_ALIMENTO_P291_COUNT,y=ECV_ALIMENTO_P291_COUNTXR,by=c("barrio","estrato"))
ECV_ALIMENTO_P291_K291 <- merge(x=ECV_ALIMENTO_P291_K291,y=ECV_ALIMENTO_P291_CTB,by=c("barrio"))
#Calculo indicadores 
ECV_ALIMENTO_P291_K291 <- within(ECV_ALIMENTO_P291_K291,k_291_1 <- totalRespuestaE / totalEncuestadosE  )
ECV_ALIMENTO_P291_K291 <- within(ECV_ALIMENTO_P291_K291,k_291_2 <- totalRespuestaE / TotalB  )


ECV_ALIMENTO_P291_K291 <- merge(x=ECV_ALIMENTO_P291_K291,y=ECV_BASICO,by = c("barrio","estrato"))

ECV_ALIMENTO_P291_K291 <- ECV_ALIMENTO_P291_K291[,c("comuna","barrio","estrato","p_291","totalRespuestaE","totalEncuestadosE","TotalB","k_291_1","k_291_2")]
```
Grafico

```{r}
library(ggplot2)
ggplot(subset(ECV_ALIMENTO_P291_K291,comuna=="ALTAVISTA"),aes(x=estrato, y=k_291_1, fill=p_291)) + geom_bar( stat="identity",position = "stack")+facet_wrap( ~ barrio)+ggtitle("Personas que piensan que por falta de dinero se quedan sin comida por Estrato en Barrios Comuna")
```

Dimensión Alimentación.
P_292: En este hogar: En los ultimos 30 días, ¿Alguna vez en su hogar se quedaron sin dinero para obtener una alimentación nutritiva:...?
Indicador: Porcentaje de personas que no puedieron obtener una alimenatación nutritiva por falta de dinero.
Consideración:Se detecta que en los hogares existe la posibilidad que se hubiera llenado más de una encuestas, por este motivo se determina unificar el resultado de las encuestas por medio de la moda.
Formula: 
  Totales de personas SI / Totales Encuestados P_292
  Totales de personas NO / Totales Encuestados P_292

1. Adecuo la informacion para la contruccion de los indicadores para P_292
```{r}
ECV_ALIMENTO_P292 <- ECV_ALIMENTO_DEP[c("encuesta","comuna","barrio","estrato","p_292")]
```
2.Generación de un registro por encuesta.
```{r}
if (exists('ECV_ALIMENTO_P292_AGG')) rm(ECV_ALIMENTO_P292_AGG)
  

ECV_ALIMENTO_P292_AGG <- ECV_ALIMENTO_P292 %>% group_by(encuesta,comuna,barrio,estrato) %>%
summarise(p_292 = getmode(p_292)) %>% ungroup()
```

3. Se procede a calcular los indicadores depues de realizar el agrupamiento mediante la moda
```{r}
#separo un dataSet con la informacion importante para calcular el indicador
if(exists('ECV_ALIMENTO_P292')) rm(ECV_ALIMENTO_P292)
ECV_ALIMENTO_P292 <- ECV_ALIMENTO_P292_AGG[,c("barrio","estrato","p_292")]

#Genero un conteo del toral de respuestas por barrio y estrato
ECV_ALIMENTO_P292_COUNTXR <- aggregate(ECV_ALIMENTO_P292$p_292,by=list(ECV_ALIMENTO_P292$barrio,ECV_ALIMENTO_P292$estrato,ECV_ALIMENTO_P292$p_292),function(x){NROW(x)})
ECV_ALIMENTO_P292_COUNTXR <- setNames(ECV_ALIMENTO_P292_COUNTXR,c("barrio",'estrato',"p_292","totalRespuestaE"))

#Genero un conteo del toral de respuestas por barrio 
ECV_ALIMENTO_P292_CTB <- aggregate(ECV_ALIMENTO_P292$p_292,by=list(ECV_ALIMENTO_P292$barrio),function(x){NROW(x)})
ECV_ALIMENTO_P292_CTB <- setNames(ECV_ALIMENTO_P292_CTB,c("barrio","TotalB"))

#Separo otro DataSet con el barrio, estrato y la cantidad de respuestas para calcular el total #encuestado
ECV_ALIMENTO_P292_COUNT <- ECV_ALIMENTO_P292_COUNTXR[,c("barrio","estrato","totalRespuestaE")]
ECV_ALIMENTO_P292_COUNT <- aggregate(ECV_ALIMENTO_P292_COUNTXR$totalRespuesta,by=list(ECV_ALIMENTO_P292_COUNTXR$barrio,ECV_ALIMENTO_P292_COUNTXR$estrato), FUN="sum")

ECV_ALIMENTO_P292_COUNT <- setNames(ECV_ALIMENTO_P292_COUNT,c("barrio","estrato","totalEncuestadosE"))
# se cuenta con 2 dataSet para generar el indicador k_p295
ECV_ALIMENTO_P292_K292 <- merge(x=ECV_ALIMENTO_P292_COUNT,y=ECV_ALIMENTO_P292_COUNTXR,by=c("barrio","estrato"))
ECV_ALIMENTO_P292_K292 <- merge(x=ECV_ALIMENTO_P292_K292,y=ECV_ALIMENTO_P292_CTB,by=c("barrio"))
#Calculo indicadores 
ECV_ALIMENTO_P292_K292 <- within(ECV_ALIMENTO_P292_K292,k_292_1 <- totalRespuestaE / totalEncuestadosE  )
ECV_ALIMENTO_P292_K292 <- within(ECV_ALIMENTO_P292_K292,k_292_2 <- totalRespuestaE / TotalB  )


ECV_ALIMENTO_P292_K292 <- merge(x=ECV_ALIMENTO_P292_K292,y=ECV_BASICO,by = c("barrio","estrato"))

ECV_ALIMENTO_P292_K292 <- ECV_ALIMENTO_P292_K292[,c("comuna","barrio","estrato","p_292","totalRespuestaE","totalEncuestadosE","TotalB","k_292_1","k_292_2")]
```
GRAFICO P_292
```{r}
library(ggplot2)
ggplot(subset(ECV_ALIMENTO_P292_K292,comuna=="ALTAVISTA"),aes(x=estrato, y=k_292_1, fill=p_292)) + geom_bar( stat="identity",position = "stack")+facet_wrap( ~ barrio)
```

4. dataFrame principales de indicadores.
  ECV_ALIMENTO_P291_K291
  ECV_ALIMENTO_P292_K292
  
```{r}
ECV_ALIMENTO_K2911_K2921 <- merge(x=ECV_ALIMENTO_P291_K291,y=ECV_ALIMENTO_P292_K292,by = c("comuna","barrio","estrato"))

sub_ECV_ALIMENTO_K2911_K2921 <- subset(ECV_ALIMENTO_K2911_K2921,comuna == 'ALTAVISTA')
cor(sub_ECV_ALIMENTO_K2911_K2921$k_291_1,sub_ECV_ALIMENTO_K2911_K2921$k_292_1)

```

cierro los objetos que ya no necesito.
```{r}
if(exists('ECV_ALIMENTO_P292')) rm(ECV_ALIMENTO_P292)
if(exists('ECV_ALIMENTO_P292_AGG')) rm(ECV_ALIMENTO_P292_AGG)
if(exists('ECV_ALIMENTO_P292_COUNT')) rm(ECV_ALIMENTO_P292_COUNT)
if(exists('ECV_ALIMENTO_P292_COUNTXR')) rm(ECV_ALIMENTO_P292_COUNTXR)
if(exists('ECV_ALIMENTO_P292_CTB')) rm(ECV_ALIMENTO_P292_CTB)
```

  
5. GRAFICO DE CORRELACION

```{r}
library(GGally)

ggpairs(sub_ECV_ALIMENTO_K2911_K2921, columns = c("k_291_2","k_292_2"), ggplot2::aes(colour=barrio)) 
```

Dimensión Alimentación.
P_295: En este hogar: En los ultimos 30 días, ¿Alguna vez en su hogar se quedaron sin alimentos por falta de dinero?
Indicador: Porcentaje de personas que alguna vez en su hogar se quedaron sin alimentos por falta de comida.
Consideración:Se detecta que en los hogares existe la posibilidad que se hubiera llenado más de una encuestas, por este motivo se determina unificar el resultado de las encuestas por medio de la moda.
Formula: 
  Totales de personas SI / Totales Encuestados P_295
  Totales de personas NO / Totales Encuestados P_295

1. Se crea un dataSet con la informacion de la pregunta p_295
```{r}
ECV_ALIMENTO_P295 <- ECV_ALIMENTO_DEP[c("encuesta","comuna","barrio","estrato","p_295")]
```
2.Generación de un registro por encuesta.
```{r}
library(dplyr)
library(magrittr)
ECV_ALIMENTO_P295_AGG <- ECV_ALIMENTO_P295 %>% group_by(encuesta,comuna,barrio,estrato) %>% summarise(p_295 = getmode(p_295)) %>% ungroup()

```
```{r}
#separo un dataSet con la informacion importante para calcular el indicador
if(exists('ECV_ALIMENTO_P295')) rm(ECV_ALIMENTO_P295)
ECV_ALIMENTO_P295 <- ECV_ALIMENTO_P295_AGG[,c("barrio","estrato","p_295")]

#Genero un conteo del toral de respuestas por barrio y estrato
ECV_ALIMENTO_P295_COUNTXR <- aggregate(ECV_ALIMENTO_P295$p_295,by=list(ECV_ALIMENTO_P295$barrio,ECV_ALIMENTO_P295$estrato,ECV_ALIMENTO_P295$p_295),function(x){NROW(x)})
ECV_ALIMENTO_P295_COUNTXR <- setNames(ECV_ALIMENTO_P295_COUNTXR,c("barrio",'estrato',"p_295","totalRespuestaE"))

#Genero un conteo del toral de respuestas por barrio 
ECV_ALIMENTO_P295_CTB <- aggregate(ECV_ALIMENTO_P295$p_295,by=list(ECV_ALIMENTO_P295$barrio),function(x){NROW(x)})
ECV_ALIMENTO_P295_CTB <- setNames(ECV_ALIMENTO_P295_CTB,c("barrio","TotalB"))

#Separo otro DataSet con el barrio, estrato y la cantidad de respuestas para calcular el total #encuestado
ECV_ALIMENTO_P295_COUNT <- ECV_ALIMENTO_P295_COUNTXR[,c("barrio","estrato","totalRespuestaE")]
ECV_ALIMENTO_P295_COUNT <- aggregate(ECV_ALIMENTO_P295_COUNTXR$totalRespuesta,by=list(ECV_ALIMENTO_P295_COUNTXR$barrio,ECV_ALIMENTO_P295_COUNTXR$estrato), FUN="sum")

ECV_ALIMENTO_P295_COUNT <- setNames(ECV_ALIMENTO_P295_COUNT,c("barrio","estrato","totalEncuestadosE"))
# se cuenta con 2 dataSet para generar el indicador k_p295
ECV_ALIMENTO_P295_K295 <- merge(x=ECV_ALIMENTO_P295_COUNT,y=ECV_ALIMENTO_P295_COUNTXR,by=c("barrio","estrato"))
ECV_ALIMENTO_P295_K295 <- merge(x=ECV_ALIMENTO_P295_K295,y=ECV_ALIMENTO_P295_CTB,by=c("barrio"))
#Calculo indicadores 
ECV_ALIMENTO_P295_K295 <- within(ECV_ALIMENTO_P295_K295,k_295_1 <- totalRespuestaE / totalEncuestadosE  )
ECV_ALIMENTO_P295_K295 <- within(ECV_ALIMENTO_P295_K295,k_295_2 <- totalRespuestaE / TotalB  )


ECV_ALIMENTO_P295_K295 <- merge(x=ECV_ALIMENTO_P295_K295,y=ECV_BASICO,by = c("barrio","estrato"))

ECV_ALIMENTO_P295_K295 <- ECV_ALIMENTO_P295_K295[,c("comuna","barrio","estrato","p_295","totalRespuestaE","totalEncuestadosE","TotalB","k_295_1","k_295_2")]
```

```{r}
if(exists('ECV_ALIMENTO_P295')) rm(ECV_ALIMENTO_P295)
if(exists('ECV_ALIMENTO_P295_AGG')) rm(ECV_ALIMENTO_P295_AGG)
if(exists('ECV_ALIMENTO_P295_COUNT')) rm(ECV_ALIMENTO_P295_COUNT)
if(exists('ECV_ALIMENTO_P295_COUNTXR')) rm(ECV_ALIMENTO_P295_COUNTXR)
if(exists('ECV_ALIMENTO_P295_CTB')) rm(ECV_ALIMENTO_P295_CTB)
```
5. GRAFICO DE CORRELACION
dataSet principales
ECV_ALIMENTO_P291_K291
ECV_ALIMENTO_P292_K292
ECV_ALIMENTO_P295_K295
```{r}
library(ggplot2)
ggplot(subset(ECV_ALIMENTO_P295_K295,comuna=="ALTAVISTA"),aes(x=estrato, y=k_295_1, fill=p_295)) + geom_bar( stat="identity",position = "stack")+facet_wrap( ~ barrio)
```



################################## propuesta Juan David ###################################

```{r}
library('sqldf')
sqldf("select barrio, count(p_291) from ECV_ALIMENTO_DEP  WHERE p_291 = '1' group by barrio")
```



**Dimensión Vivienda y Servicios Públicos**

La dimensión de vivienda y servicios públicos miden dentro de la encuesta de calidad de vida como viven los Medellinenses, en que condiciones estan sus hogares a nivel de tipo de vivienda y sus características físicas: material de paredes y pisos,t enencia y financiación de la vivienda: tipo de tenencia de la vivienda; tenencia de escritura de propiedad; subsidios recibidos para la compra, construcción, mejora, titulación o escrituración de la vivienda.


```{r}
ECV_VIVIENDA <- ECV[,c("encuesta","persona","comuna","barrio","estrato","p_1","p_12","p_26","p_30","p_146",
                       "p_149","p_158","p_160","p_162","p_164","p_165","p_169","p_173","p_174","p_178","p_180","p_226")]
```

No existen valores nulos dentro de las preguntas de vivienda 
```{r}
summary(ECV_VIVIENDA)
```


Para la el análisis de la dimensión de VIVIENDA Y SERVICIOS PUBLICOS en los barrios de Medellín se toman las siguientes preguntas con sus respectivos indicadores:

* P_12 - Cuántas personas componen este hogar?
  * Indicador: Promedio de personas por hogar
  * Fórmula: Número de personas en cada hogar / Número total de hogares

* P_26 - Por qué causa Principalmente se vino a vivir a este municipio?
 * Indicador: Porcentaje de hogares por barrio que han llegado por problemas de orden público
 * Fórmula: Cantidad de hogares que llegaron al barrio por problemas de orden público / Número total de hogares
 
* P_30 - ¿Cuánto hace que vive en ESTE BARRIO o VEREDA? En años
 *Indicador: Porcentaje de familias que han vivo en el barrio o vereda por más de 6 añios
 * Fórmula: Cantidad de hogares que llevan viviendo en el barrio o vereda más de 6 añios / Número total de hogares

* P_146 - Tipo de Vivienda
 * Indicador_1: Porcentaje de hogares del barrio que viven en Rancho o vivienda de desechos (1)
 * Indicador_2: Porcentaje de hogares del barrio que viven en Cuarto(s) (2)
 * Indicador_3: Porcentaje de hogares del barrio que viven en Cuartos en inquilinato (3)
 * Indicador_4: Porcentaje de hogares del barrio que viven en Apartamento (4)
 * Indicador_5: Porcentaje de hogares del barrio que viven en Casa (5)
 * Fórmula: Cantidad de hogares que viven en .... / Número total de hogares


* P_149 - ¿De dónde obtiene principalmente esta vivienda el agua para consumo humano?
 * Indicador: Porcentaje de hogares que toman el agua de entidades prestadoras de servicios públicos domiciliarios (1)
 * Fórmula: Cantidad de hogares que toman el agua de entidades prestadoras de servicios públicos domiciliarios / Número total de hogares

* P_158 - La unidad de vivienda cuenta con servicios públicos de Energía (1)
  P_162 - La unidad de vivienda cuenta con servicios públicos de Acueducto (1)
  P_165 - La unidad de vivienda cuenta con servicios públicos de Alcantarillado (1)
  P_174 - La unidad de vivienda cuenta con servicios públicos de Aseo (recolección) (1)
  * Indicador: Porcentaje de hogares con acceso a almenos uno de los servicios públicos básicos
  * Fórmula: Cantidad de hogares con acceso al menos uno de los servicios públicos básicos / Número total de hogares
  
* P_160 - La unidad de vivienda cuenta con servicios públicos de Estado Suspendido Energía (1)
  P_164 - La unidad de vivienda cuenta con servicios públicos de Estado Suspendido Acueducto (1)
  P_173 - La unidad de vivienda cuenta con servicios públicos de Estado Suspendido Gas Natural (1)
  P_169 -	La unidad de vivienda cuenta con servicios públicos de Estado Suspendido Telefono (línea fija) (1)
  P_180 -	La unidad de vivienda cuenta con servicios públicos de Estado Suspendido Internet (1)
  * Indicador: Porcentaje de hogares en el momento de la encuesta con algún servicios públicos suspendido (1)
  * Fórmula: Número de hogares con algún servicios públicos suspendido / Número total de hogares
  
* P_178 - La unidad de vivienda cuenta con servicios públicos de Conexión a Internet
  * Indicador: Porcentaje de hogares con servicios públicos de Conexión a Internet (1) 
  * Fórmula: Número de hogares con con servicios públicos de Conexión a Internet / Número total de hogares
  
* P_226 - La vivienda ocupada por este hogar es?
 * Indicador_1: Porcentaje de hogares en arriendo o subarriendo mensual (1) 
 * Indicador_2: Porcentaje de hogares en propia (2,3) 
 * Indicador_3: Porcentaje de hogares en otras condiciones (4,5,6) 
 * Fórmula: Número de hogares ocupadas bajo la caracteristica ... / Número total de hogares


Cálculo P_12

```{r}
#Se toma el máximo número de integrantes por encuesta
ECV_VIVIENDA_BARRIO <-ECV_VIVIENDA %>% select(encuesta,barrio,p_12) %>% 
                      group_by(encuesta, barrio) %>% 
                      summarise(total = n_distinct(encuesta),p_12 = max(p_12)) %>% ungroup() %>% 
                      group_by(barrio) %>% summarise(total = sum(total), p_12 = sum(p_12) / sum(total)) %>%   ungroup() 
#write.xlsx(ECV_VIVIENDA[ECV_VIVIENDA$barrio == 'AGUAS FRÍAS',], 'aguasfrias2.xlsx') 
```

Cálculo P_26

```{r}
#ECV_VIVIENDA[,c("p_26")]
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_26 == 1,] %>% 
       group_by(encuesta, barrio) %>% summarise(p_26 = min(p_26)) %>% ungroup() %>%
       group_by(barrio) %>% summarise(p_26 = sum(p_26)) %>% ungroup()

ECV_VIVIENDA_BARRIO<-merge(x=ECV_VIVIENDA_BARRIO,y=tmp,by="barrio",all.x=TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_26 <- ECV_VIVIENDA_BARRIO$p_26 / ECV_VIVIENDA_BARRIO$total
```

Cálculo P_30

```{r}
ECV_VIVIENDA$p_antiguedad <- ifelse(ECV_VIVIENDA$p_30 >= 0 & ECV_VIVIENDA$p_30 <= 5, 1, ifelse(ECV_VIVIENDA$p_30 < 0, 0, 2))
# 1 menos de 5 años, 0 No sabe, 2 más de 6 años

tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_antiguedad == 2,] %>% 
       group_by(encuesta, barrio) %>% summarise(p_30 = n_distinct(p_antiguedad)) %>% ungroup() %>%
       group_by(barrio) %>% summarise(p_30 = sum(p_30)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x=ECV_VIVIENDA_BARRIO, y=tmp,by="barrio", all.x=TRUE) 

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_30 <- ECV_VIVIENDA_BARRIO$p_30 / ECV_VIVIENDA_BARRIO$total 
```

*Cálculo P_146_1*

```{r}
#ECV_VIVIENDA[ECV_VIVIENDA$p_146 == 1,]
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_146 == 1,] %>% 
       group_by(encuesta, barrio) %>% summarise(p_146 = min(p_146)) %>% ungroup() %>%
       group_by(barrio) %>% summarise(p_146 = sum(p_146)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x=ECV_VIVIENDA_BARRIO,y=tmp,by="barrio",all.x=TRUE) 

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_146 <- ECV_VIVIENDA_BARRIO$p_146 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_146'] <- 'p_146_1'
```

*Cálculo P_146_2*

```{r}
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_146 == 2,] %>% 
       group_by(encuesta, barrio) %>% summarise(p_146 = min(p_146)) %>% ungroup() %>%
       group_by(barrio) %>% summarise(p_146 = sum(p_146)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x=ECV_VIVIENDA_BARRIO,y=tmp,by="barrio",all.x=TRUE) 

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_146 <- ECV_VIVIENDA_BARRIO$p_146 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_146'] <- 'p_146_2'
```

*Cálculo P_146_3*

```{r}
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_146 == 3,] %>% 
       group_by(encuesta, barrio) %>% summarise(p_146 = min(p_146)) %>% ungroup() %>%
       group_by(barrio) %>% summarise(p_146 = sum(p_146)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x=ECV_VIVIENDA_BARRIO,y=tmp,by="barrio",all.x=TRUE) 

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_146 <- ECV_VIVIENDA_BARRIO$p_146 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_146'] <- 'p_146_3'
```

*Cálculo P_146_4*

```{r}
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_146 == 4,] %>% 
       group_by(encuesta, barrio) %>% summarise(p_146 = min(p_146)) %>% ungroup() %>%
       group_by(barrio) %>% summarise(p_146 = sum(p_146)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x=ECV_VIVIENDA_BARRIO,y=tmp,by="barrio",all.x=TRUE) 

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_146 <- ECV_VIVIENDA_BARRIO$p_146 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_146'] <- 'p_146_4'
```

*Cálculo P_146_5*

```{r}
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_146 == 5,] %>% 
       group_by(encuesta, barrio) %>% summarise(p_146 = min(p_146)) %>% ungroup() %>%
       group_by(barrio) %>% summarise(p_146 = sum(p_146)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x=ECV_VIVIENDA_BARRIO,y=tmp,by="barrio",all.x=TRUE) 

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_146 <- ECV_VIVIENDA_BARRIO$p_146 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_146'] <- 'p_146_5'
```

Cálculo P_149

```{r}
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_149 == 1,] %>% 
       group_by(encuesta, barrio) %>% summarise(p_149 = min(p_149)) %>% ungroup() %>%
       group_by(barrio) %>% summarise(p_149 = sum(p_149)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x=ECV_VIVIENDA_BARRIO,y=tmp,by="barrio",all.x=TRUE) 

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_149 <- ECV_VIVIENDA_BARRIO$p_149 / ECV_VIVIENDA_BARRIO$total 
```

Cálculo Servicios Públicos Básicos (P_158, P_162, P_165, P_174)

```{r}
ECV_VIVIENDA$p_SP <- ifelse(ECV_VIVIENDA$p_158 == 1 & ECV_VIVIENDA$p_162 == 1 & ECV_VIVIENDA$p_165 == 1
                          & ECV_VIVIENDA$p_174 == 1, 1, 0)

tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_SP == 1,] %>% 
       group_by(encuesta, barrio) %>% summarise(p_SP = min(p_SP)) %>% ungroup() %>%
       group_by(barrio) %>% summarise(p_SP = sum(p_SP)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x=ECV_VIVIENDA_BARRIO, y=tmp, by="barrio", all.x=TRUE) 

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_SP <- ECV_VIVIENDA_BARRIO$p_SP / ECV_VIVIENDA_BARRIO$total
```

Cálculo Servicios Públicos Suspendidos (P_160, P_164, P_173, P_169, P_180)

```{r}
ECV_VIVIENDA$p_SPS <- ifelse(ECV_VIVIENDA$p_160 == 1 | ECV_VIVIENDA$p_164 == 1 | ECV_VIVIENDA$p_173 == 1
                          | ECV_VIVIENDA$p_169 == 1 | ECV_VIVIENDA$p_180 == 1, 1, 0)

tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_SPS == 1,] %>% 
       group_by(encuesta, barrio) %>% summarise(p_SPS = min(p_SPS)) %>% ungroup() %>%
       group_by(barrio) %>% summarise(p_SPS = sum(p_SPS)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x=ECV_VIVIENDA_BARRIO,y=tmp,by="barrio",all.x=TRUE) 

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_SPS <- ECV_VIVIENDA_BARRIO$p_SPS / ECV_VIVIENDA_BARRIO$total
```

Cálculo P_178

```{r}
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_178 == 1,] %>% 
       group_by(encuesta, barrio) %>% summarise(p_178 = min(p_178)) %>% ungroup() %>%
       group_by(barrio) %>% summarise(p_178 = sum(p_178)) %>% ungroup()

ECV_VIVIENDA_BARRIO<-merge(x=ECV_VIVIENDA_BARRIO,y=tmp,by="barrio",all.x=TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_178 <- ECV_VIVIENDA_BARRIO$p_178 / ECV_VIVIENDA_BARRIO$total
```

*P_226_1*

```{r}
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_226 == 1,] %>% 
       group_by(encuesta, barrio) %>% summarise(p_226 = min(p_226)) %>% ungroup() %>%
       group_by(barrio) %>% summarise(p_226 = sum(p_226)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x=ECV_VIVIENDA_BARRIO, y=tmp,by="barrio", all.x=TRUE) 

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_226 <- ECV_VIVIENDA_BARRIO$p_226 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_226'] <- 'p_226_1'
```

*P_226_2*

```{r}
tmp <- subset(ECV_VIVIENDA, p_226 == 2 | p_226 == 3) %>% 
       group_by(encuesta, barrio) %>% summarise(p_226 = min(p_226)) %>% ungroup() %>%
       group_by(barrio) %>% summarise(p_226 = sum(p_226)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x=ECV_VIVIENDA_BARRIO, y=tmp,by="barrio", all.x=TRUE) 

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_226 <- ECV_VIVIENDA_BARRIO$p_226 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_226'] <- 'p_226_2'
```

*P_226_3*

```{r}
tmp <- subset(ECV_VIVIENDA, p_226 == 4 | p_226 == 5 | p_226 == 6) %>% 
       group_by(encuesta, barrio) %>% summarise(p_226 = min(p_226)) %>% ungroup() %>%
       group_by(barrio) %>% summarise(p_226 = sum(p_226)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x=ECV_VIVIENDA_BARRIO, y=tmp,by="barrio", all.x=TRUE) 

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_226 <- ECV_VIVIENDA_BARRIO$p_226 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_226'] <- 'p_226_3'
```

Depuración de columnas

```{r}
ECV_VIVIENDA_BARRIO$total <- NULL
```

**Dimensión Salud**


La dimensión de salud mide que tan informados se encuentran las Medellinenses sobre los métodos de planificación familiar y que tanto hacen uso del sistema de salud de la ciudad.


```{r}
ECV_SALUD <- ECV[,c("encuesta","persona","comuna","barrio","estrato","p_15","p_307","p_308","p_324","p_325","p_326","p_327")]
```

!!!!Existen valores nulos!!!!!
```{r}
summary(ECV_SALUD)
```

Para la el análisis de la dimensión de SALUD en los barrios de Medellín se toman las siguientes preguntas con sus respectivos indicadores:

* P_307 - ¿Considera que tiene suficiente información acerca de los métodos de planificación familiar?
 * Indicador: Porcentaje de personas que consideran que tienen suficiente información sobre los métodos de planificación familiar
 * Fórmula: Cantidad de personas que consideran que tienen suficiente información sobre los métodos de planificación familiar / Total de personas encuestadas

P_308 - ¿Usted planifica?
 * Indicador: Porcentaje de mujeres que planifican (2)	
 * Fórmula: Cantidad de mujeres que planifican / Total de mujeres encuestadas

P_324 - ¿En los últimos 30 días, tuvo alguna enfermedad, accidente, problema odontológico, o algún otro problema de salud que no haya implicado hospitalización?
 * Indicador: Porcentaje de personas que en los últimos 30 días han tenido algún problema de salud y no haya necesitado hospitalización
 * Fórmula: Cantidad de personas que en los últimos 30 días han tenido algún problema de salud y no haya necesitado hospitalización / Total de personas encuestadas

P_325 - ¿Para tratar ese problema de salud, que hizo principalmente?
 * Indicador: 
 * Fórmula:
 
P_326 - ¿Cuál fue la principal razón por la que no solicitó o no recibió atención por el problema de salud?
 * Indicador: 
 * Fórmula:
 
P_327 - En los últimos 12 meses (en caso de no haberlos utilizado ponga (0) Utilizó los servicios de promoción y prevención
 * Indicador:
 * Fórmula:
 
Cálculo Número total de encuestados
```{r}
ECV_SALUD_BARRIO <- ECV_SALUD %>% select(encuesta,barrio,persona) %>% 
                    group_by(encuesta, barrio) %>% 
                    summarise(total = max(persona)) %>% ungroup() %>% 
                    group_by(barrio) %>% summarise(total = sum(total)) %>% ungroup()
```

Cálculo P_307

```{r}
tmp <- ECV_SALUD[ECV_SALUD$p_307 == 1,] %>% 
       group_by(encuesta, barrio) %>% summarise(p_307 = sum(p_307)) %>% ungroup() %>%
       group_by(barrio) %>% summarise(p_307 = sum(p_307)) %>% ungroup()

ECV_SALUD_BARRIO <- merge(x=ECV_SALUD_BARRIO,y=tmp,by="barrio",all.x=TRUE) 

if(exists('tmp')) rm(tmp)

ECV_SALUD_BARRIO$p_307 <- ECV_SALUD_BARRIO$p_307 / ECV_SALUD_BARRIO$total
```

```{r}
#write.xlsx(ECV_SALUD[ECV_SALUD$barrio == 'AGUAS FRÍAS',], 'aguasfrias.xlsx')
```

Cálculo Número total de mujeres encuestadas

```{r}
tmp <- ECV_SALUD[ECV_SALUD$p_15 == 2,] %>% select(encuesta,barrio,persona) %>% 
       group_by(encuesta, barrio) %>% summarise(total_mujer = n_distinct(persona)) %>% ungroup() %>% 
       group_by(barrio) %>% summarise(total_mujer = sum(total_mujer)) %>% ungroup()

ECV_SALUD_BARRIO <- merge(x=ECV_SALUD_BARRIO,y=tmp,by="barrio",all.x=TRUE) 

if(exists('tmp')) rm(tmp)

```

Cálculo P_308

```{r}
tmp <- subset(ECV_SALUD, p_15 == 2 & p_308 == 1) %>% select(encuesta,barrio,persona) %>% 
       group_by(encuesta, barrio) %>% summarise(p_308 = max(persona)) %>% ungroup() %>% 
       group_by(barrio) %>% summarise(p_308 = sum(p_308)) %>% ungroup()

ECV_SALUD_BARRIO <- merge(x=ECV_SALUD_BARRIO,y=tmp,by="barrio",all.x=TRUE) 

if(exists('tmp')) rm(tmp)

ECV_SALUD_BARRIO$p_308 <- ECV_SALUD_BARRIO$p_308 / ECV_SALUD_BARRIO$total_mujer
```

Cálculo P_324 (1)

```{r}
tmp <- ECV_SALUD[ECV_SALUD$p_324 == 1,] %>% 
         group_by(encuesta, barrio)  %>% summarise(p_324 = max(persona)) %>% ungroup() %>%
         group_by(barrio) %>% summarise(p_324 = sum(p_324)) %>% ungroup()

ECV_SALUD_BARRIO <- merge(x=ECV_SALUD_BARRIO,y=tmp,by="barrio",all.x=TRUE) 

if(exists('tmp')) rm(tmp)

ECV_SALUD_BARRIO$p_324 <- ECV_SALUD_BARRIO$p_324 / ECV_SALUD_BARRIO$total
```

Depuración de columnas

```{r}
ECV_SALUD_BARRIO$total <- NULL
ECV_SALUD_BARRIO$total_mujer <- NULL
```
 
