---
title: "Agrupamientos de los barrios de Medellín"
author: Santiago Arboleda Quiroz, Olga Lucía Montoya Pérez, Alberto Ramirez Velasquez,
  Juan David Tangarife Patino
date: "Semestre 02-2019"
---

En este trabajo se abordará el problema de agrupar los barrios de Medellín de acuerdo a distintas dimensiones y
analizar espacialmente las agrupaciones.

**Dimensión Vivienda y Servicios Públicos**

La dimensión de vivienda y servicios públicos miden dentro de la encuesta de calidad de vida como viven los Medellinenses, en que condiciones estan sus hogares a nivel de tipo de vivienda y sus características físicas: material de paredes y pisos tenencias y financiación de la vivienda: tipo de tenencia de la vivienda; tenencia de escritura de propiedad; subsidios recibidos para la compra, construcción, mejora, titulación o escrituración de la vivienda

Para la el análisis de la dimensión de VIVIENDA Y SERVICIOS PUBLICOS en los barrios de Medellín se toman las siguientes preguntas con sus respectivos indicadores:

* P_12 - Cuántas personas componen este hogar?
  * Indicador: Promedio de personas por hogar
  * Fórmula: Número de personas en cada hogar / Número total de hogares

* P_26 - Por qué causa Principalmente se vino a vivir a este municipio?
 * Indicador: Porcentaje de hogares por barrio que han llegado por problemas de orden público
 * Fórmula: Cantidad de hogares que llegaron al barrio por problemas de orden público / Número total de hogares
 
* P_30 - ¿Cuánto hace que vive en ESTE BARRIO o VEREDA? En años
 * Indicador_1: Porcentaje de familias que han vivo en el barrio o vereda por más de 6 años
 * Fórmula: Cantidad de hogares que llevan viviendo en el barrio o vereda más de 6 años / Número total de hogares
 * Indicador_2: Tiempo promedio de permanencia de las personas en el barrio
 * Fórmula: Sumatoria de los tiempos de permanencia de las personas en el barrio / Número total de hogares

* P_146 - Tipo de Vivienda
 * Indicador_1: Porcentaje de hogares del barrio que viven en Rancho o vivienda de desechos (1)
 * Indicador_2: Porcentaje de hogares del barrio que viven en Cuarto(s) (2)
 * Indicador_3: Porcentaje de hogares del barrio que viven en Cuartos en inquilinato (3)
 * Indicador_4: Porcentaje de hogares del barrio que viven en Apartamento (4)
 * Indicador_5: Porcentaje de hogares del barrio que viven en Casa (5)
 * Fórmula: Cantidad de hogares que viven en .... / Número total de hogares


* P_149 - ¿De dónde obtiene principalmente esta vivienda el agua para consumo humano?
 * Indicador: Porcentaje de hogares que toman el agua de entidades prestadoras de servicios públicos domiciliarios (1)
 * Fórmula: Cantidad de hogares que toman el agua de entidades prestadoras de servicios públicos domiciliarios / Número total de hogares

* P_158 - La unidad de vivienda cuenta con servicios públicos de Energía (1)
  P_162 - La unidad de vivienda cuenta con servicios públicos de Acueducto (1)
  P_165 - La unidad de vivienda cuenta con servicios públicos de Alcantarillado (1)
  P_174 - La unidad de vivienda cuenta con servicios públicos de Aseo (recolección) (1)
  * Indicador: Porcentaje de hogares con acceso a almenos uno de los servicios públicos básicos
  * Fórmula: Cantidad de hogares con acceso al menos uno de los servicios públicos básicos / Número total de hogares
  
* P_160 - La unidad de vivienda cuenta con servicios públicos de Estado Suspendido Energía (1)
  P_164 - La unidad de vivienda cuenta con servicios públicos de Estado Suspendido Acueducto (1)
  P_173 - La unidad de vivienda cuenta con servicios públicos de Estado Suspendido Gas Natural (1)
  P_169 -	La unidad de vivienda cuenta con servicios públicos de Estado Suspendido Telefono (línea fija) (1)
  P_180 -	La unidad de vivienda cuenta con servicios públicos de Estado Suspendido Internet (1)
  * Indicador: Porcentaje de hogares en el momento de la encuesta con algún servicios públicos suspendido (1)
  * Fórmula: Número de hogares con algún servicios públicos suspendido / Número total de hogares
  
* P_178 - La unidad de vivienda cuenta con servicios públicos de Conexión a Internet
  * Indicador: Porcentaje de hogares con servicios públicos de Conexión a Internet (1) 
  * Fórmula: Número de hogares con con servicios públicos de Conexión a Internet / Número total de hogares
  
* P_226 - La vivienda ocupada por este hogar es?
 * Indicador_1: Porcentaje de hogares en arriendo o subarriendo mensual (1) 
 * Indicador_2: Porcentaje de hogares en propia (2,3) 
 * Indicador_3: Porcentaje de hogares en otras condiciones (4,5,6) 
 * Fórmula: Número de hogares ocupadas bajo la caracteristicas de cada uno de los indicadores / Número total de hogares
 
El insumo principal de este trabajo son los datos abiertos del portal Medata[1] y en particular la Encuesta de Calidad de Vida Medellín Cómo vamos.
```{r}
ECV <- read.csv("./dataSet/encuesta_calidad_vida.csv", header = TRUE, sep=";")
```

Definiciones:

Cuando las preguntas hacen referencia a nivel de hogar, tomaremos la moda como referencia, es decir, el valor más representativo en las respuestas obtenidas en ese hogar. La proporción se hará sobre el total de los encuestados.


Librerias a utilizar en el desarrollo del proyecto
```{r}
#library(xlsx)
library("factoextra")
library(cluster)
library(plyr)
library(ggplot2)
library(GGally)
library(dplyr)
library(magrittr)
library('sqldf')
library(rgdal)
library(leaflet)
library(plotly)
```

Función que permite sacar la moda para las preguntas orientadas a hogares
```{r}
getmode <- function(v) {
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
}
```

Se procede a normalizar las cabeceras del dataframe del set de datos
```{r}
names_ECV <- names(ECV)
i = 1
l_names <- list()
for (name_col in names_ECV) {
    str_col <- unlist(strsplit(name_col," "))
    str_col <- unlist(strsplit(str_col,"[.]"))
    if (length(str_col) > 2){
        l_names[i] <- paste(str_col[2],str_col[3],sep = '_')    
    }
    else
    {
        l_names[i] <- paste(str_col[2])   
    }

    i = i + 1
}

ECV <- setNames(ECV,l_names)
```

**1. Caracterización de las dimensiones para la dimensión VIVIENDA Y SERVICIOS PUBLICOS**

Construcción del dataframe con las preguntas de interes para la dimensión vivienda y servicios públicos
```{r}
ECV_VIVIENDA <- ECV[,c("encuesta","persona","comuna","barrio","estrato","p_1","p_12","p_26","p_30","p_146",
                       "p_149","p_158","p_160","p_162","p_164","p_165","p_169","p_173","p_174","p_178","p_180","p_226")]
```

No existen valores nulos dentro de las preguntas de vivienda 
```{r}
summary(ECV_VIVIENDA)
```

Se procede a realizar el cálculo de cada uno de los indicadores definidos para la dimensión Vivienda y 

* Cálculo P_12. Promedio de personas por hogar

```{r}
#Se toma el máximo número de integrantes por encuesta
ECV_VIVIENDA_BARRIO <-ECV_VIVIENDA %>% select(encuesta,comuna, barrio,p_12) %>% 
                      group_by(encuesta, comuna, barrio) %>% 
                      summarise(total = n_distinct(encuesta),p_12 = max(p_12)) %>% ungroup() %>% 
                      group_by(comuna,barrio) %>% summarise(total = sum(total), p_12 = sum(p_12) / sum(total)) %>%   ungroup() 
#write.xlsx(ECV_VIVIENDA[ECV_VIVIENDA$barrio == 'AGUAS FRÍAS',], 'aguasfrias2.xlsx') 
```

* Cálculo P_26. Porcentaje de hogares por barrio que han llegado por problemas de orden público

```{r}
#ECV_VIVIENDA[,c("p_26")]
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_26 == 1,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_26 = min(p_26)) %>% ungroup() %>%
       group_by(comuna,barrio) %>% summarise(p_26 = sum(p_26)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_26 <- ECV_VIVIENDA_BARRIO$p_26 / ECV_VIVIENDA_BARRIO$total
```

* Cálculo P_30. Porcentaje de familias que han vivo en el barrio o vereda por más de 6 años

```{r}
ECV_VIVIENDA$p_antiguedad <- ifelse(ECV_VIVIENDA$p_30 >= 0 & ECV_VIVIENDA$p_30 <= 5, 1, ifelse(ECV_VIVIENDA$p_30 < 0, 0, 2))
# 1 menos de 5 años, 0 No sabe, 2 más de 6 años

tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_antiguedad == 2,] %>% 
       group_by(encuesta, comuna ,barrio) %>% summarise(p_30 = n_distinct(p_antiguedad)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_30 = sum(p_30)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_30 <- ECV_VIVIENDA_BARRIO$p_30 / ECV_VIVIENDA_BARRIO$total 
```

 *Cálculo P_146_1. Porcentaje de hogares del barrio que viven en Rancho o vivienda de desechos

```{r}
#ECV_VIVIENDA[ECV_VIVIENDA$p_146 == 1,]
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_146 == 1,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_146 = n_distinct(p_146)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_146 = sum(p_146)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_146 <- ECV_VIVIENDA_BARRIO$p_146 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_146'] <- 'p_146_1'
```

  *Cálculo P_146_2. Porcentaje de hogares del barrio que viven en Cuarto(s)

```{r}
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_146 == 2,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_146 = n_distinct(p_146)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_146 = sum(p_146)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_146 <- ECV_VIVIENDA_BARRIO$p_146 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_146'] <- 'p_146_2'
```

  *Cálculo P_146_3. Porcentaje de hogares del barrio que viven en Cuartos en inquilinato

```{r}
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_146 == 3,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_146 = n_distinct(p_146)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_146 = sum(p_146)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_146 <- ECV_VIVIENDA_BARRIO$p_146 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_146'] <- 'p_146_3'
```

  *Cálculo P_146_4. Porcentaje de hogares del barrio que viven en Apartamento

```{r}
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_146 == 4,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_146 = n_distinct(p_146)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_146 = sum(p_146)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_146 <- ECV_VIVIENDA_BARRIO$p_146 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_146'] <- 'p_146_4'
```

  *Cálculo P_146_5. Porcentaje de hogares del barrio que viven en Casa

```{r}
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_146 == 5,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_146 = n_distinct(p_146)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_146 = sum(p_146)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE) 

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_146 <- ECV_VIVIENDA_BARRIO$p_146 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_146'] <- 'p_146_5'
```

* Cálculo P_149. Porcentaje de hogares que toman el agua de entidades prestadoras de servicios públicos domiciliarios

```{r}
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_149 == 1,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_149 = getmode(p_149)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_149 = sum(p_149)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE) 

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_149 <- ECV_VIVIENDA_BARRIO$p_149 / ECV_VIVIENDA_BARRIO$total 
```

* Cálculo Servicios Públicos Básicos (P_158, P_162, P_165, P_174)

```{r}
ECV_VIVIENDA$p_SP <- ifelse(ECV_VIVIENDA$p_158 == 1 & ECV_VIVIENDA$p_162 == 1 & ECV_VIVIENDA$p_165 == 1
                          & ECV_VIVIENDA$p_174 == 1, 1, 0)

tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_SP == 1,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_SP = getmode(p_SP)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_SP = sum(p_SP)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_SP <- ECV_VIVIENDA_BARRIO$p_SP / ECV_VIVIENDA_BARRIO$total
```

* Cálculo Servicios Públicos Suspendidos (P_160, P_164, P_173, P_169, P_180)

```{r}
ECV_VIVIENDA$p_SPS <- ifelse(ECV_VIVIENDA$p_160 == 1 | ECV_VIVIENDA$p_164 == 1 | ECV_VIVIENDA$p_173 == 1
                          | ECV_VIVIENDA$p_169 == 1 | ECV_VIVIENDA$p_180 == 1, 1, 0)

tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_SPS == 1,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_SPS = getmode(p_SPS)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_SPS = sum(p_SPS)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_SPS <- ECV_VIVIENDA_BARRIO$p_SPS / ECV_VIVIENDA_BARRIO$total
```

* Cálculo P_178. Porcentaje de hogares con servicios públicos de Conexión a Internet

```{r}
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_178 == 1,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_178 = min(p_178)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_178 = sum(p_178)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_178 <- ECV_VIVIENDA_BARRIO$p_178 / ECV_VIVIENDA_BARRIO$total
```

  *P_226_1. Porcentaje de hogares en arriendo o subarriendo mensual

```{r}
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_226 == 1,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_226 = n_distinct(encuesta)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_226 = sum(p_226)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_226 <- ECV_VIVIENDA_BARRIO$p_226 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_226'] <- 'p_226_1'
```

  *P_226_2. Porcentaje de hogares con propia

```{r}
tmp <- subset(ECV_VIVIENDA, p_226 == 2 | p_226 == 3) %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_226 = n_distinct(encuesta)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_226 = sum(p_226)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE) 

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_226 <- ECV_VIVIENDA_BARRIO$p_226 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_226'] <- 'p_226_2'
```

  *P_226_3. Porcentaje de hogares en otras condiciones

```{r}
tmp <- subset(ECV_VIVIENDA, p_226 == 4 | p_226 == 5 | p_226 == 6) %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_226 = n_distinct(encuesta)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_226 = sum(p_226)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE) 

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_226 <- ECV_VIVIENDA_BARRIO$p_226 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_226'] <- 'p_226_3'
```

Depuración de columnas

```{r}
ECV_VIVIENDA_BARRIO$total <- NULL
```


**Estadisticas básicas VIVIENDA**

```{r}
summary(ECV_VIVIENDA_BARRIO)
```

**2. Agrupamientos**

- Imputación de los valores Nulos - 

Para efectos de la ejecución de los modelos, los valores del data frame ECV_VIVIENDA_BARRIO que sean nulos se llenan con 0 dado que cuando se presenta un valor NAN significa que el indicador no aplica para el barrio y el cero lo representa
```{r}
ECV_VIVIENDA_BARRIO[is.na(ECV_VIVIENDA_BARRIO)] <- 0
```

- Normalización de los datos - 

Si bien, la mayoria de los indicadores del dataframe ECV_VIVIENDA_BARRIO se encuentran en función de hogares existe un indicador en función de personas del hogar, por lo tanto es necesario poner todos los indicadores en la misma escala
```{r}
#Kmeans no acepta variables categoricas, el identificador del barrio se convierte en nombre de filas para que no sean consideras por el algoritmo
#ECV_VIVIENDA_BARRIO_SCALE <- tibble::column_to_rownames(ECV_VIVIENDA_BARRIO, var = c("comuna","barrio"))

#ECV_VIVIENDA_BARRIO_SCALE <- scale(ECV_VIVIENDA_BARRIO_SCALE)

#ECV_VIVIENDA_BARRIO_SCALE <- ECV_VIVIENDA_BARRIO %>% mutate_if(is.numeric,scale)
```
```{r}
ECV_VIVIENDA_BARRIO_CP <- ECV_VIVIENDA_BARRIO
ECV_VIVIENDA_BARRIO_CP$barrio <- paste(ECV_VIVIENDA_BARRIO_CP$comuna,ECV_VIVIENDA_BARRIO_CP$barrio,sep = "-")
ECV_VIVIENDA_BARRIO_CP$comuna <- NULL

ECV_VIVIENDA_BARRIO_SCALE <- tibble::column_to_rownames(ECV_VIVIENDA_BARRIO_CP, var = "barrio")

```

Se utilizan diferentes métodos para determinar el k óptimo a utilizar en el algoritmo de clusterización - Kmeans


  * Método del codo 

```{r}
fviz_nbclust(ECV_VIVIENDA_BARRIO_SCALE, kmeans, method = "wss") + labs(title= "Número óptimo de Clusters") + xlab("Número de Cluster (K)") 
```

 * Diferencia entre los errores generados con diferentes k

```{r}
SS <- fviz_nbclust(ECV_VIVIENDA_BARRIO_SCALE, kmeans, method = "wss")
plot(2:10,diff(SS$data$y), type = "h", main="Diferencia en errores", xlab="k", ylab="diff") 
```

  * Método de la siluetta 

```{r}
fviz_nbclust(ECV_VIVIENDA_BARRIO_SCALE, kmeans, method = "silhouette")
```

De acuerdo a las gráficas de los diferentes métodos, se concluye que k = 3, es el k óptimo para la dimensión VIVIENDA Y SERVICIOS PUBLICOS, por lo cual aplicaremos el algoritmo Kmeans con dicho valor de k 

```{r}
#ECV_VIVIENDA_BARRIO[,3:15]
set.seed(1988)
kmeans_model <- kmeans(ECV_VIVIENDA_BARRIO_SCALE, 3, nstart = 50)
```
El modelo da un ajuste del 60.4% con k = 3

Se procede a agregar el cluster a la data original
```{r}
df_member <- cbind(ECV_VIVIENDA_BARRIO, cluster = kmeans_model$cluster)
head(df_member)
```

Visualizando los grupos
```{r}
fviz_cluster(kmeans_model, data = ECV_VIVIENDA_BARRIO_SCALE, geom = "point") + ggtitle("Distribución de los barrios en los clusters")
```
Recordemos las indicadores asociados a la dimensión VIVIENDA

* P_12 - Promedio de personas por hogar
* P_26 - Porcentaje de hogares por barrio que han llegado por problemas de orden público
* P_30 - Porcentaje de familias que han vivo en el barrio o vereda por más de 6 años
* P_146_1 - Porcentaje de hogares del barrio que viven en Rancho o vivienda de desechos
* P_146_2 - Porcentaje de hogares del barrio que viven en Cuarto(s) 
* P_146_3 - Porcentaje de hogares del barrio que viven en Cuartos en inquilinato
* P_146_4 - Porcentaje de hogares del barrio que viven en Apartamento
* P_146_5 - Porcentaje de hogares del barrio que viven en Casa
* P_149 - Porcentaje de hogares que toman el agua de entidades prestadoras de servicios públicos domiciliarios 
* P_158 - Porcentaje de hogares con acceso a almenos uno de los servicios públicos básicos
* P_160 - Porcentaje de hogares en el momento de la encuesta con algún servicios públicos suspendido
* P_178 - Porcentaje de hogares con servicios públicos de Conexión a Internet
* P_226_1 - Porcentaje de hogares en arriendo o subarriendo mensual
* P_226_2 - Porcentaje de hogares en propia (2,3) 
* P_226_3 - Porcentaje de hogares en otras condiciones (4,5,6)


Análisis para cada uno de los grupos

*Grupo 1*

```{r}
summary(df_member[df_member$cluster == 1,])
```

En promedio hay 2.9 habitantes por hogar en los barrios de este grupo, este grupo de barrios dentro de su población tiene en promedio un 2% de hogares que han llegado  por problemas de orden público, el 65% de los hogares llevan más de 6 años viviendo en estos barrios y viven mayormente en apartamento, casi siempre propio o arrendado, en donde el agua es tomada de las entidades prestaras de servicios públicos y cuenta con acceso a los servicios públicos básicos. Al menos el 70% de los apartamentos cuentan con acceso a internet. 

*Grupo 2*
```{r}
df_member[df_member$cluster == 2,]
```
Barrios con promedio de 4 personas por hogar, al menos el 70% de los hogares han vivido allá por más de 6 años en sus casas o apartamentos arrendados o propios, cuantan con los servicios páblicos básicos, solo el 9% de ellos tienen suspendido alguno de los servicios , menos del 45% de los hogares de este grupo no tienen internet. 8% de los hogares de este barrio han llegado al sector por problemas de orden público.

*Grupo 3*
```{r}
summary(df_member[df_member$cluster == 3,])
```

Barrios donde predominan las casas, el 80% de los hogares viven en casas, con un promedio de 3.5 habitantes por hogar, sus propiedades en más del 60% son propias, no todos los hogares toman el agua de las entidades prestadoras de servicios públicos y al menos el 54% de los hogares tienen acceso a los servicios públicos básicos, muy pocos (6%) de los que tienen acceso a los servicios públicos lo tienen suspendido. Solo el 27% de los hogares tienen acceso a internet 


*Análisis general de los grupos de acuerdo a las preguntas de la Encuesta de Calidad de Vida de Medellín*


```{r}
ECV_VIVIENDA_KMEANS <- kmeans_model$centers
ECV_VIVIENDA_KMEANS <- data.frame(ECV_VIVIENDA_KMEANS)
ECV_VIVIENDA_KMEANS %>% tibble::rownames_to_column("cluster") -> ECV_VIVIENDA_KMEANS

ECV_VIVIENDA_KMEANS$cluster <- as.factor(ECV_VIVIENDA_KMEANS$cluster)
 
summary_cluster_means <- ggparcoord(data = ECV_VIVIENDA_KMEANS, columns = c(2:14), groupColumn = "cluster", scale = "globalminmax", showPoints = TRUE, alphaLines = 0.5) + labs(x = "Indicador / Preguntas", y = "Medias", title = "Análisis General de los cluster de acuerdo a las preguntas de la dimensión") + theme(plot.title = element_text(size=12), axis.text=element_text(size=8))

ggplotly(summary_cluster_means)

```

Caracteristicas que distinguen un grupo de barrios de otro

 - Grupo 1: se caracterizan por tener menos personas por hogar, viven mayormente en apartamentos propios con acceso a los servicios públicos básicos e internet 
 
 - Grupo 2: se caracterizan por tener más población en su hogar y combinar sus viviendas entre apartamentos y casas
 
 - Grupo 3: se caracterizan por vivir mayoremente en casas propias, el acceso al agua proviene principalmente de otros medios diferentes a las entidades prestadoras de servicios y la gran mayoría de la población no cuenta con servicios públicos básicos ni internet

Conozcamos los barrios que pertenecen a cada uno de estos grupos

```{r}
#df_member[order(df_member$cluster),]
df_member[df_member$cluster == 1,]$barrio
```

```{r}
df_member[df_member$cluster == 2,]$barrio
```

```{r}
df_member[df_member$cluster == 3,]$barrio
```


**3. Análisis espacial **

Se cargan las subdivisiones territoriales de Medellín, tomadas de la página web de opendata[2] 

```{r}
barrios_med <- readOGR("./dataSet/Barrio_Vereda/Barrio_Vereda.shp",layer="Barrio_Vereda")
#Conversión de codificaciones 
nombres_barrios <- iconv(barrios_med@data$NOMBRE,"UTF-8","ISO_8859-1")
```


```{r}
df_member$barrio <- tolower(df_member$barrio)
```

Función que busca capitalizar los nombres de los barrios
```{r}
Caps <- function(x) {
  s <- strsplit(x, " ")[[1]]
  paste(toupper(substring(s, 1,1)), substring(s, 2), sep="", collapse=" ")
}

df_member$barrio <- sapply(df_member$barrio, Caps)
```

Debido a inconsistenias entre los nombres de los barrios de la data de poligonos y los nombres de los barrios de la Encuesta de Calidad de Vida, se procede a realizar reemplazos manuales

```{r}
df_member$barrio[df_member$barrio == "Barrios De JesÃ Âºs"] <- "Barrios de JesÃ Âºs"
df_member$barrio[df_member$barrio == "Piedras Blancas"] <- "Piedras Blancas - Matasano"
df_member$barrio[df_member$barrio == "Area Expansion San Antonio De Prado"] <- "Ã\u0081rea de ExpansiÃÂ³n San Antonio de Prado"
df_member$barrio[df_member$barrio == "Prado"] <- "San Antonio de Prado"
df_member$barrio[df_member$barrio == "Altavista Central"] <- "Altavista Sector Central"
df_member$barrio[df_member$barrio == "San JosÃÂ© Del Manzanillo"] <- "San JosÃÂ© del Manzanillo"
df_member$barrio[df_member$barrio == "El Yolombo"] <- "Yolombo"
df_member$barrio[df_member$barrio == "Urquita"] <- "UrquitÃÂ¡"
df_member$barrio[df_member$barrio == "Corregimiento Palmitas"] <- "Palmitas Sector Central"
df_member$barrio[df_member$barrio == "San Jose De La MontaÃÂ±a"] <- "San JosÃÂ© de La MontaÃÂ±a"
df_member$barrio[df_member$barrio == "Cabecera San CristÃÂ³bal"] <- "Cabecera Urbana Corregimiento San CristÃÂ³bal"
df_member$barrio[df_member$barrio == "Area Expansion Pajarito"] <- "ÃÂrea de ExpansiÃÂ³n Pajarito"
df_member$barrio[df_member$barrio == "Area De Expancion San Cristobal"] <- "ÃÂrea de ExpansiÃÂ³n San CristÃÂ³bal"
df_member$barrio[df_member$barrio == "Santa Maria De Los ÃÂ¡ngeles"] <- "Santa MarÃ?a de Los ÃÂngeles"
df_member$barrio[df_member$barrio == "Juan Pablo Ii"] <- "Parque Juan Pablo II"
df_member$barrio[df_member$barrio == "Bombona No.1"] <- "BombonÃÂ¡ No.1"
df_member$barrio[df_member$barrio == "Bombona No.2"] <- "BombonÃÂ¡ No.2"
df_member$barrio[df_member$barrio == "La Asomadera No.1"] <- "Asomadera No.1"
df_member$barrio[df_member$barrio == "La Asomadera No.2"] <- "Asomadera No.2"
df_member$barrio[df_member$barrio == "Los Cerros El Verjel"] <- "Los Cerros El Vergel"
df_member$barrio[df_member$barrio == "Villa Tina"] <- "Villatina"
df_member$barrio[df_member$barrio == "Santa Ines"] <- "Santa InÃÂ©s"
df_member$barrio[df_member$barrio == "Campo Valdes No.2"] <- "Campo ValdÃÂ©s No.2"
df_member$barrio[df_member$barrio == "Progreso"] <- "El Progreso"
df_member$barrio[df_member$barrio == "Progreso  no.2"] <- "Progreso No.2"
df_member$barrio[df_member$barrio == "Doce De Octubre No.1"] <- "Doce de Octubre No.1"
df_member$barrio[df_member$barrio == "Doce De Octubre No.2"] <- "Doce de Octubre No.2"
df_member$barrio[df_member$barrio == "Santo Domingo Sabio No.1"] <- "Santo Domingo Savio No.1"
df_member$barrio[df_member$barrio == "Santo Domingo Sabio No.2"] <- "Santo Domingo Savio No.2"
df_member$barrio[df_member$barrio == "Moscu No.1"] <- "MoscÃÂº No.1"
df_member$barrio[df_member$barrio == "Moscu No.2"] <- "MoscÃÂº No.2"
df_member$barrio[df_member$barrio == "San Josela Cima No.1"] <- "San JosÃÂ© La Cima No.1"
df_member$barrio[df_member$barrio == "San Jose La Cima No.2"] <- "San JosÃÂ© La Cima No.2"
df_member$barrio[df_member$barrio == "Villa Del Socorro"] <- "Villa del Socorro"
df_member$barrio[df_member$barrio == "Andalucia"] <- "AndalucÃ?a"


df_member$barrio[df_member$barrio == "Urquitá"] <- "AndalucÃ?a"
df_member$barrio[df_member$barrio == "San José de La Montaña"] <- "AndalucÃ?a"
df_member$barrio[df_member$barrio == "Área de Expansión Pajarito"] <- "AndalucÃ?a"
df_member$barrio[df_member$barrio == "Área de Expansión San Antonio de Prado"] <- "Área de Expansión San Antonio de Prado"
df_member$barrio[df_member$barrio == "San José del Manzanillo"] <- "Área de Expansión San Antonio de Prado"
```

```{r}
df_member$barrio
```


```{r}
barrios_med$NOMBRE
```
```




Selección de los campos necesarios, barrio y cluster
```{r}
df_member %>% select(barrio, cluster) -> df_member
```


Se unen los dataframe de barrios_med en donde se encuentra los poligonos de los barrios de Medellín con su respectivo cluster
```{r}
barrios_cluster <- merge(barrios_med, df_member[!duplicated(df_member$barrio), ], by.x="NOMBRE", by.y="barrio",  all.x = TRUE)
```

Se procede a dibujar el mapa de Medellín señalando cada uno de los barrios a que cluster pertenece

```{r}
map <-leaflet(barrios_cluster)
factpal <- colorFactor(topo.colors(4), barrios_cluster$cluster)
map <- addPolygons(map, popup = nombres_barrios, color = ~factpal(cluster),
  dashArray = "2",
  fillOpacity = 0.7,
  highlight = highlightOptions(
      weight = 5,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE),
    #label = labels,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto"))
                 
map <- addTiles(map)
map
```

Espacialmente se evidenica que por la dimensión VIVIENDA Y SERVICIOS PUBLICOS los datos se distribuyen

Referencias
[1] Encuesta calidad de vida.  http://medata.gov.co/dataset/encuesta-calidad-de-vida
[2] Barrio Vereda. https://geomedellin-m-medellin.opendata.arcgis.com/datasets/c844f0fd764f41b2a808d8747457de8a_4
