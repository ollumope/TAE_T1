---
title: "Agrupamientos de los barrios de Medell&iacute;n - Dimensi&oacute;n Vivienda y Servicios P&uacute;blicos"
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

La dimensi&oacute;n de vivienda y servicios p&uacute;blicos mide dentro de la encuesta de calidad de vida como viven los Medellinenses, en que condiciones estan sus hogares a nivel de tipo de vivienda y sus características fisicas, materialesl de paredes y pisos tenencias, financiación de la viviend,: tipo de tenencia de la vivienda; tenencia de escritura de propiedad; subsidios recibidos para la compra, construcción, mejora, titulación o escrituración de la vivienda

Para el an&aacute;lisis de la dimensi&oacute;n de VIVIENDA Y SERVICIOS PUBLICOS en los barrios de Medell&iacute;n se toman las siguientes preguntas con sus respectivos indicadores, estas preguntas son seleccionadas a la luz de descubrir si las condiciones de la dimensi&ocuate;n aporta a la calidad de vida de los habitantes de los barrios de Medell&iacute;n:

* P_12 - Cu&aacute;ntas personas componen este hogar?

Indicador: Promedio de personas por hogar
F&oacute;rmula: N&uacute;mero de personas en cada hogar / N&uacute;mero total de hogares

* P_26 - Por qu&eacute; causa Principalmente se vino a vivir a este municipio?
Posibles respuestas:
    * -99	No responde
    * -98	No sabe
    * -88	No aplica
    * -77	Otra
    * 1	Orden P&uacute;blico
    * 2	Estudio
    * 3	B&uacute;squeda de trabajo
    * 4	Venta de tierra
    * 5	Razones familiares
    * 6	Fen&oacute;meno natural
    * 7	Motivos laborales
    * 8	Razones de salud
    * 9	Traslado del hogar
    * 10	Nos quedaba cerca
    * 11	Nos pareci&oacute; atractiva

Indicador: Porcentaje de hogares por barrio que han llegado por problemas de orden p&uacute;blico
F&oacute;rmula: Cantidad de hogares que llegaron al barrio por problemas de orden p&uacute;blico / N&uacute;mero total de hogares
 
* P_30 - ¿Cu&aacute;nto hace que vive en ESTE BARRIO o VEREDA? En a&ntilde;os
Indicador_1: Porcentaje de familias que han vivo en el barrio o vereda por m&aacute;s de 6 a&ntilde;os
F&oacute;rmula: Cantidad de hogares que llevan viviendo en el barrio o vereda m&aacute;s de 6 a&ntilde;os / N&uacute;mero total de hogares
Posibles respuestas:
    * -99	No responde
    * -98	No sabe

Indicador_2: Tiempo promedio de permanencia de las personas en el barrio
F&oacute;rmula: Sumatoria de los tiempos de permanencia de las personas en el barrio / N&uacute;mero total de hogares

* P_146 - Tipo de Vivienda
Posibles respuestas:
    * 1	Rancho o vivienda de desechos
    * 2	Cuarto(s)
    * 3	Cuartos en inquilinato
    * 4	Apartamento
    * 5	Casa
    
Indicador_1: Porcentaje de hogares del barrio que viven en Rancho o vivienda de desechos (1)
Indicador_2: Porcentaje de hogares del barrio que viven en Cuarto(s) (2)
Indicador_3: Porcentaje de hogares del barrio que viven en Cuartos en inquilinato (3)
Indicador_4: Porcentaje de hogares del barrio que viven en Apartamento (4)
Indicador_5: Porcentaje de hogares del barrio que viven en Casa (5)
F&oacute;rmula: Cantidad de hogares que viven en .... / N&uacute;mero total de hogares


* P_149 - ¿De d&oacute;nde obtiene principalmente esta vivienda el agua para consumo humano?
Posibles respuestas:
    * 1	Entidad prestadora de servicios p&uacute;blicos domiciliarios
    * 2	Acueducto veredal o comunal
    * 3	Pozo con bomba
    * 4	Pozo sin bomba, aljibe, jaguey o barreno
    * 5	Agua lluvia
    * 6	R&iacute;o, quebrada o manantial, nacimiento
    * 7	Pila p&uacute;blica
    * 8	Carro tanque
    * 9	Aguatero
    * 10	Agua embotellada o en bolsa

Indicador: Porcentaje de hogares que toman el agua de entidades prestadoras de servicios p&uacute;blicos domiciliarios (1)
F&oacute;rmula: Cantidad de hogares que toman el agua de entidades prestadoras de servicios p&uacute;blicos domiciliarios / N&uacute;mero total de hogares
 
* P_158 - La unidad de vivienda cuenta con servicios p&uacute;blicos de Energ&iacute;a (1)
  P_162 - La unidad de vivienda cuenta con servicios p&uacute;blicos de Acueducto (1)
  P_165 - La unidad de vivienda cuenta con servicios p&uacute;blicos de Alcantarillado (1)
  P_174 - La unidad de vivienda cuenta con servicios p&uacute;blicos de Aseo (recolecci&oacute;n) (1)
Posibles respuestas:  
    * 1	Si
    * 2	No

Indicador: Porcentaje de hogares con acceso a almenos uno de los servicios p&uacute;blicos b&aacute;sicos
F&oacute;rmula: Cantidad de hogares con acceso al menos uno de los servicios p&uacute;blicos b&aacute;sicos / N&uacute;mero total de hogares
  
* P_160 - La unidad de vivienda cuenta con servicios p&uacute;blicos de Estado Suspendido Energ&iacute;a (1)
  P_164 - La unidad de vivienda cuenta con servicios p&uacute;blicos de Estado Suspendido Acueducto (1)
  P_173 - La unidad de vivienda cuenta con servicios p&uacute;blicos de Estado Suspendido Gas Natural (1)
  P_169 -	La unidad de vivienda cuenta con servicios p&uacute;blicos de Estado Suspendido Telefono (l&iacute;nea fija) (1)
  P_180 -	La unidad de vivienda cuenta con servicios p&uacute;blicos de Estado Suspendido Internet (1)

Indicador: Porcentaje de hogares en el momento de la encuesta con alg&uacute;n servicios p&uacute;blicos suspendido (1)
F&oacute;rmula: N&uacute;mero de hogares con alg&uacute;n servicios p&uacute;blicos suspendido / N&uacute;mero total de hogares
  
* P_178 - La unidad de vivienda cuenta con servicios p&uacute;blicos de Conexi&oacute;n a Internet
Posibles respuestas:  
    * 1	Si
    * 2	No
    
Indicador: Porcentaje de hogares con servicios p&uacute;blicos de Conexi&oacute;n a Internet (1) 
F&oacute;rmula: N&uacute;mero de hogares con con servicios p&uacute;blicos de Conexi&oacute;n a Internet / N&uacute;mero total de hogares
  
* P_226 - La vivienda ocupada por este hogar es?
Posibles respuestas: 
    * 1	En arriendo o subarriendo mensual
    * 2	Propia, la est&aacute;n pagando mensualmente
    * 3	Propia, totalmente pagada
    * 4	En usufructo
    * 5	Ocupante de hecho
    * 6	Anticresis

Indicador_1: Porcentaje de hogares en arriendo o subarriendo mensual (1) 
Indicador_2: Porcentaje de hogares en propia (2,3) 
Indicador_3: Porcentaje de hogares en otras condiciones (4,5,6) 
F&oacute;rmula: N&uacute;mero de hogares ocupadas bajo la caracter&iacute;sticas de cada uno de los indicadores / N&uacute;mero total de hogares


```{r}
#Librerias a utilizar en el desarrollo del proyecto
#library(xlsx)
library("factoextra")
library(cluster)
library(plyr)
library(ggplot2)
library(GGally)
library(dplyr)
library(magrittr)
library('sqldf')
library(rgdal)
library(leaflet)
library(plotly)
```
 
El insumo principal de este trabajo son los datos abiertos del portal Medata[1] y en particular la Encuesta de Calidad de Vida Medell&iacute;n C&oacute;mo vamos.
```{r}
ECV <- read.csv("./dataSet/encuesta_calidad_vida.csv", header = TRUE, sep=";")
```

```{r}
#Funci&oacute;n que permite sacar la moda para las preguntas orientadas a hogares
getmode <- function(v) {
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
}
```

```{r}
#Se procede a normalizar las cabeceras del dataframe del set de datos
names_ECV <- names(ECV)
i = 1
l_names <- list()
for (name_col in names_ECV) {
    str_col <- unlist(strsplit(name_col," "))
    str_col <- unlist(strsplit(str_col,"[.]"))
    if (length(str_col) > 2){
        l_names[i] <- paste(str_col[2],str_col[3],sep = '_')    
    }
    else
    {
        l_names[i] <- paste(str_col[2])   
    }

    i = i + 1
}

ECV <- setNames(ECV,l_names)
```

**1. Caracterizaci&oacute;n de las dimensiones para la dimensi&oacute;n VIVIENDA Y SERVICIOS PUBLICOS**

```{r}
#Construcci&oacute;n del dataframe con las preguntas de interes para la dimensi&oacute;n vivienda y servicios p&uacute;blicos
ECV_VIVIENDA <- ECV[,c("encuesta","persona","comuna","barrio","estrato","p_1","p_12","p_26","p_30","p_146",
                       "p_149","p_158","p_160","p_162","p_164","p_165","p_169","p_173","p_174","p_178","p_180","p_226")]
```

Analizando el conjunto de preguntas seleccionadas para esta dimensi&oacute;n, se evidencia que todas ellas fueron respondidas por los encuestados, puesto que no existen valores nulos, la mayor&iacute;a de los hogares encuestados son estrato 2 
```{r}
summary(ECV_VIVIENDA)
```


```{r}
# Se procede a realizar el c&aacute;lculo de cada uno de los indicadores definidos para la dimensi&oacute;n Vivienda y Servicios p&uacute;blicos
# 
# * C&aacute;lculo P_12. Promedio de personas por hogar
ECV_VIVIENDA_BARRIO <-ECV_VIVIENDA %>% select(encuesta,comuna, barrio,p_12) %>% 
                      group_by(encuesta, comuna, barrio) %>% 
                      summarise(total = n_distinct(encuesta),p_12 = max(p_12)) %>% ungroup() %>% 
                      group_by(comuna,barrio) %>% summarise(total = sum(total), p_12 = sum(p_12) / sum(total)) %>%   ungroup() 
#write.xlsx(ECV_VIVIENDA[ECV_VIVIENDA$barrio == 'AGUAS FR&iacute;AS',], 'aguasfrias2.xlsx') 
```

```{r}
#* C&aacute;lculo P_26. Porcentaje de hogares por barrio que han llegado por problemas de orden p&uacute;blico
#ECV_VIVIENDA[,c("p_26")]
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_26 == 1,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_26 = min(p_26)) %>% ungroup() %>%
       group_by(comuna,barrio) %>% summarise(p_26 = sum(p_26)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_26 <- ECV_VIVIENDA_BARRIO$p_26 / ECV_VIVIENDA_BARRIO$total
```


```{r}
#* C&aacute;lculo P_30. Porcentaje de familias que han vivo en el barrio o vereda por m&aacute;s de 6 a&ntilde;os
ECV_VIVIENDA$p_antiguedad <- ifelse(ECV_VIVIENDA$p_30 >= 0 & ECV_VIVIENDA$p_30 <= 5, 1, ifelse(ECV_VIVIENDA$p_30 < 0, 0, 2))
# 1 menos de 5 a&ntilde;os, 0 No sabe, 2 m&aacute;s de 6 a&ntilde;os

tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_antiguedad == 2,] %>% 
       group_by(encuesta, comuna ,barrio) %>% summarise(p_30 = n_distinct(p_antiguedad)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_30 = sum(p_30)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_30 <- ECV_VIVIENDA_BARRIO$p_30 / ECV_VIVIENDA_BARRIO$total 
```


```{r}
#*C&aacute;lculo P_146_1. Porcentaje de hogares del barrio que viven en Rancho o vivienda de desechos
#ECV_VIVIENDA[ECV_VIVIENDA$p_146 == 1,]
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_146 == 1,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_146 = n_distinct(p_146)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_146 = sum(p_146)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_146 <- ECV_VIVIENDA_BARRIO$p_146 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_146'] <- 'p_146_1'
```


```{r}
#*C&aacute;lculo P_146_2. Porcentaje de hogares del barrio que viven en Cuarto(s)
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_146 == 2,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_146 = n_distinct(p_146)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_146 = sum(p_146)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_146 <- ECV_VIVIENDA_BARRIO$p_146 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_146'] <- 'p_146_2'
```

```{r}
#*C&aacute;lculo P_146_3. Porcentaje de hogares del barrio que viven en Cuartos en inquilinato
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_146 == 3,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_146 = n_distinct(p_146)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_146 = sum(p_146)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_146 <- ECV_VIVIENDA_BARRIO$p_146 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_146'] <- 'p_146_3'
```


```{r}
#*C&aacute;lculo P_146_4. Porcentaje de hogares del barrio que viven en Apartamento
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_146 == 4,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_146 = n_distinct(p_146)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_146 = sum(p_146)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_146 <- ECV_VIVIENDA_BARRIO$p_146 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_146'] <- 'p_146_4'
```


```{r}
#*C&aacute;lculo P_146_5. Porcentaje de hogares del barrio que viven en Casa
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_146 == 5,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_146 = n_distinct(p_146)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_146 = sum(p_146)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE) 

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_146 <- ECV_VIVIENDA_BARRIO$p_146 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_146'] <- 'p_146_5'
```


```{r}
#* C&aacute;lculo P_149. Porcentaje de hogares que toman el agua de entidades prestadoras de servicios p&uacute;blicos domiciliarios
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_149 == 1,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_149 = getmode(p_149)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_149 = sum(p_149)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE) 

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_149 <- ECV_VIVIENDA_BARRIO$p_149 / ECV_VIVIENDA_BARRIO$total 
```


```{r}
#* C&aacute;lculo Servicios P&uacute;blicos B&aacute;sicos (P_158, P_162, P_165, P_174)
ECV_VIVIENDA$p_SP <- ifelse(ECV_VIVIENDA$p_158 == 1 & ECV_VIVIENDA$p_162 == 1 & ECV_VIVIENDA$p_165 == 1
                          & ECV_VIVIENDA$p_174 == 1, 1, 0)

tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_SP == 1,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_SP = getmode(p_SP)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_SP = sum(p_SP)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_SP <- ECV_VIVIENDA_BARRIO$p_SP / ECV_VIVIENDA_BARRIO$total
```


```{r}
#* C&aacute;lculo Servicios P&uacute;blicos Suspendidos (P_160, P_164, P_173, P_169, P_180)
ECV_VIVIENDA$p_SPS <- ifelse(ECV_VIVIENDA$p_160 == 1 | ECV_VIVIENDA$p_164 == 1 | ECV_VIVIENDA$p_173 == 1
                          | ECV_VIVIENDA$p_169 == 1 | ECV_VIVIENDA$p_180 == 1, 1, 0)

tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_SPS == 1,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_SPS = getmode(p_SPS)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_SPS = sum(p_SPS)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_SPS <- ECV_VIVIENDA_BARRIO$p_SPS / ECV_VIVIENDA_BARRIO$total
```


```{r}
#* C&aacute;lculo P_178. Porcentaje de hogares con servicios p&uacute;blicos de Conexi&oacute;n a Internet
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_178 == 1,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_178 = min(p_178)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_178 = sum(p_178)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_178 <- ECV_VIVIENDA_BARRIO$p_178 / ECV_VIVIENDA_BARRIO$total
```


```{r}
#*P_226_1. Porcentaje de hogares en arriendo o subarriendo mensual
tmp <- ECV_VIVIENDA[ECV_VIVIENDA$p_226 == 1,] %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_226 = n_distinct(encuesta)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_226 = sum(p_226)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE)

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_226 <- ECV_VIVIENDA_BARRIO$p_226 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_226'] <- 'p_226_1'
```


```{r}
#*P_226_2. Porcentaje de hogares con propia
tmp <- subset(ECV_VIVIENDA, p_226 == 2 | p_226 == 3) %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_226 = n_distinct(encuesta)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_226 = sum(p_226)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE) 

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_226 <- ECV_VIVIENDA_BARRIO$p_226 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_226'] <- 'p_226_2'
```


```{r}
#*P_226_3. Porcentaje de hogares en otras condiciones
tmp <- subset(ECV_VIVIENDA, p_226 == 4 | p_226 == 5 | p_226 == 6) %>% 
       group_by(encuesta, comuna, barrio) %>% summarise(p_226 = n_distinct(encuesta)) %>% ungroup() %>%
       group_by(comuna, barrio) %>% summarise(p_226 = sum(p_226)) %>% ungroup()

ECV_VIVIENDA_BARRIO <- merge(x = ECV_VIVIENDA_BARRIO, y = tmp,by.x=(c("comuna", "barrio")), all.x = TRUE) 

if(exists('tmp')) rm(tmp)

ECV_VIVIENDA_BARRIO$p_226 <- ECV_VIVIENDA_BARRIO$p_226 / ECV_VIVIENDA_BARRIO$total 

colnames(ECV_VIVIENDA_BARRIO)[colnames(ECV_VIVIENDA_BARRIO) == 'p_226'] <- 'p_226_3'
```


```{r}
#Depuraci&oacute;n de columnas
ECV_VIVIENDA_BARRIO$total <- NULL
```


**Estadisticas b&aacute;sicas VIVIENDA Y SERVICIOS PUBLICOS**

```{r}
summary(ECV_VIVIENDA_BARRIO)
```

Una vez c&aacute;lculado los indicadores para las hogares encuestados, se tiene que en promedio hay 3.4 personas por hogar, las personas de Medell&iacute;n no cambian mucho de barrio, permanecen en sus barrios por varios años, un 70% de ellos en promedio llevan vivendo en sus barrios por m&aacute;s de 6 años. La poblaci&oacute;n vive en mayor medida en casas y apartamentos y cuentan con servicios p&uacute;blicos b&aacute;sicos, se podr&iacute;a concluir que muchos de ellos, al menos la mitad tienen casa propia, ya pagada o pagandola actualmente.

**2. Agrupamientos**

- Imputaci&oacute;n de los valores Nulos - 

Para efectos de la ejecuci&oacute;n de los modelos, los valores del data frame ECV_VIVIENDA_BARRIO que sean nulos se llenan con 0 dado que cuando se presenta un valor NAN significa que el indicador no aplica para el barrio y el cero lo representa
```{r}
ECV_VIVIENDA_BARRIO[is.na(ECV_VIVIENDA_BARRIO)] <- 0
```

- Normalizaci&oacute;n de los datos - 

Si bien, la mayor&iacute;a de los indicadores del dataframe ECV_VIVIENDA_BARRIO se encuentran en funci&oacute;n de hogares existe un indicador en funci&oacute;n de personas del hogar, por lo tanto es necesario poner todos los indicadores en la misma escala

```{r}
ECV_VIVIENDA_BARRIO_CP <- ECV_VIVIENDA_BARRIO
#Concatenaci&oacute;n de comuna y barrio ya que existen nombres iguales de barrio en diferentes comunas
ECV_VIVIENDA_BARRIO_CP$barrio <- paste(ECV_VIVIENDA_BARRIO_CP$comuna,ECV_VIVIENDA_BARRIO_CP$barrio,sep = "-")
ECV_VIVIENDA_BARRIO_CP$comuna <- NULL

ECV_VIVIENDA_BARRIO_SCALE <- tibble::column_to_rownames(ECV_VIVIENDA_BARRIO_CP, var = "barrio")

```

Se utilizan diferentes m&eacute;todos para determinar el k &oacute;ptimo a utilizar en el algoritmo de clusterizaci&oacute;n - Kmeans


  * M&eacute;todo del codo 

```{r}
fviz_nbclust(ECV_VIVIENDA_BARRIO_SCALE, kmeans, method = "wss") + labs(title= "Número óptimo de Clusters") + xlab("Número de Cluster (K)") 
```

 * Diferencia entre los errores generados con diferentes k

```{r}
SS <- fviz_nbclust(ECV_VIVIENDA_BARRIO_SCALE, kmeans, method = "wss")
plot(2:10,diff(SS$data$y), type = "h", main="Diferencia en errores", xlab="k", ylab="diff") 
```

  * M&eacute;todo de la siluetta 

```{r}
fviz_nbclust(ECV_VIVIENDA_BARRIO_SCALE, kmeans, method = "silhouette")
```

De acuerdo a las gr&aacute;ficas de los diferentes m&eacute;todos, se concluye que k = 3, es el k &oacute;ptimo para la dimensi&oacute;n VIVIENDA Y SERVICIOS PUBLICOS, por lo cual aplicaremos el algoritmo Kmeans con dicho valor de k 

```{r}
#ECV_VIVIENDA_BARRIO[,3:15]
set.seed(1988)
kmeans_model <- kmeans(ECV_VIVIENDA_BARRIO_SCALE, 3, nstart = 50)
```
El modelo da un ajuste del 60.4% con k = 3, es un ajuste aceptable y se procede concluir de los grupos dados.


```{r}
#Se procede a agregar el cluster a la data original
df_member <- cbind(ECV_VIVIENDA_BARRIO, cluster = kmeans_model$cluster)
```

Visualizando los grupos

```{r}
fviz_cluster(kmeans_model, data = ECV_VIVIENDA_BARRIO_SCALE, geom = "point") + ggtitle("Distribución de los barrios en los clusters")
```

Recordemos las indicadores asociados a la dimensi&oacute;n VIVIENDA

* P_12 - Promedio de personas por hogar
* P_26 - Porcentaje de hogares por barrio que han llegado por problemas de orden p&uacute;blico
* P_30 - Porcentaje de familias que han vivo en el barrio o vereda por m&aacute;s de 6 a&ntilde;os
* P_146_1 - Porcentaje de hogares del barrio que viven en Rancho o vivienda de desechos
* P_146_2 - Porcentaje de hogares del barrio que viven en Cuarto(s) 
* P_146_3 - Porcentaje de hogares del barrio que viven en Cuartos en inquilinato
* P_146_4 - Porcentaje de hogares del barrio que viven en Apartamento
* P_146_5 - Porcentaje de hogares del barrio que viven en Casa
* P_149 - Porcentaje de hogares que toman el agua de entidades prestadoras de servicios p&uacute;blicos domiciliarios 
* P_158 - Porcentaje de hogares con acceso a almenos uno de los servicios p&uacute;blicos b&aacute;sicos
* P_160 - Porcentaje de hogares en el momento de la encuesta con alg&uacute;n servicios p&uacute;blicos suspendido
* P_178 - Porcentaje de hogares con servicios p&uacute;blicos de Conexi&oacute;n a Internet
* P_226_1 - Porcentaje de hogares en arriendo o subarriendo mensual
* P_226_2 - Porcentaje de hogares en propia (2,3) 
* P_226_3 - Porcentaje de hogares en otras condiciones (4,5,6)

An&aacute;lisis para cada uno de los grupos

*Grupo 1*

```{r}
summary(df_member[df_member$cluster == 1,])
```
Barrios donde predominan las casas, el 80% de los hogares viven en casas, con un promedio de 3.5 habitantes por hogar, sus propiedades en m&aacute;s del 60% son propias, no todos los hogares toman el agua de las entidades prestadoras de servicios p&uacute;blicos y al menos el 54% de los hogares tienen acceso a los servicios p&uacute;blicos b&aacute;sicos, muy pocos (6%) de los que tienen acceso a los servicios p&uacute;blicos lo tienen suspendido. Solo el 27% de los hogares tienen acceso a internet 

*Grupo 2*
```{r}
summary(df_member[df_member$cluster == 2,])
```
En promedio hay 2.9 habitantes por hogar en los barrios de este grupo, este grupo de barrios dentro de su poblaci&oacute;n tiene en promedio un 2% de hogares que han llegado  por problemas de orden p&uacute;blico, el 65% de los hogares llevan m&aacute;s de 6 a&ntilde;os viviendo en estos barrios y viven mayormente en apartamento, casi siempre propio o arrendado, en donde el agua es tomada de las entidades prestaras de servicios p&uacute;blicos y cuenta con acceso a los servicios p&uacute;blicos b&aacute;sicos. Al menos el 70% de los apartamentos cuentan con acceso a internet. 


*Grupo 3*
```{r}
summary(df_member[df_member$cluster == 3,])
```

Barrios con promedio de 4 personas por hogar, al menos el 70% de los hogares han vivido all&aacute; por m&aacute;s de 6 a&ntilde;os en sus casas o apartamentos arrendados o propios, cuantan con los servicios p&aacute;blicos b&aacute;sicos, solo el 9% de ellos tienen suspendido alguno de los servicios , menos del 45% de los hogares de este grupo no tienen internet. 8% de los hogares de este barrio han llegado al sector por problemas de orden p&uacute;blico.


```{r}
ECV_VIVIENDA_KMEANS <- kmeans_model$centers
ECV_VIVIENDA_KMEANS <- data.frame(ECV_VIVIENDA_KMEANS)
ECV_VIVIENDA_KMEANS %>% tibble::rownames_to_column("cluster") -> ECV_VIVIENDA_KMEANS

ECV_VIVIENDA_KMEANS$cluster <- as.factor(ECV_VIVIENDA_KMEANS$cluster)
 
summary_cluster_means <- ggparcoord(data = ECV_VIVIENDA_KMEANS, columns = c(2:14), groupColumn = "cluster", scale = "globalminmax", showPoints = TRUE, alphaLines = 0.5) + labs(x = "Indicador / Preguntas", y = "Medias", title = "Análisis general de los cluster") + theme(plot.title = element_text(size=12), axis.text=element_text(size=8))

ggplotly(summary_cluster_means)

```

Caracter&iacute;sticas que distinguen un grupo de barrios de otro

 - Grupo 1: se caracterizan por vivir mayoremente en casas propias, el acceso al agua proviene principalmente de otros medios diferentes a las entidades prestadoras de servicios y la gran mayor&iacute;a de la poblaci&oacute;n no cuenta con servicios p&uacute;blicos b&aacute;sicos ni internet
 
 - Grupo 2: se caracterizan por tener menos personas por hogar, viven mayormente en apartamentos propios con acceso a los servicios p&uacute;blicos b&aacute;sicos e internet 
 
 - Grupo 3: se caracterizan por tener m&aacute;s poblaci&oacute;n en su hogar y combinar sus viviendas entre apartamentos y casas
 

Conozcamos algunos barrios que pertenecen a cada uno de estos grupos

```{r}
#df_member[order(df_member$cluster),]
head(df_member[df_member$cluster == 1,]$barrio)
```

```{r}
head(df_member[df_member$cluster == 2,]$barrio)
```

```{r}
head(df_member[df_member$cluster == 3,]$barrio)
```


**3. An&aacute;lisis espacial **

Se cargan las subdivisiones territoriales de Medell&iacute;n, tomadas de la p&aacute;gina web de opendata[2] 

```{r}
barrios_med <- readOGR("./dataSet/Barrio_Vereda/Barrio_Vereda.shp",layer="Barrio_Vereda")
#Conversi&oacute;n de codificaciones 
nombres_barrios <- iconv(barrios_med@data$NOMBRE,"UTF-8","ISO_8859-1")
```


```{r}
df_member$barrio <- tolower(df_member$barrio)
```


```{r}
#Funci&oacute;n que busca capitalizar los nombres de los barrios
Caps <- function(x) {
  s <- strsplit(x, " ")[[1]]
  paste(toupper(substring(s, 1,1)), substring(s, 2), sep="", collapse=" ")
}

df_member$barrio <- sapply(df_member$barrio, Caps)
```


```{r}
#Debido a inconsistenias entre los nombres de los barrios de la data de poligonos y los nombres de los barrios de la Encuesta de Calidad de Vida, se procede a realizar reemplazos manuales

df_member$barrio[df_member$barrio == "Barrios De JesÃºs"] <- "Barrios de JesÃºs"
df_member$barrio[df_member$barrio == "Piedras Blancas"] <- "Piedras Blancas - Matasano"
df_member$barrio[df_member$barrio == "Area Expansion San Antonio De Prado"] <- "Ã\u0081rea de ExpansiÃ³n San Antonio de Prado"
df_member$barrio[df_member$barrio == "Prado"] <- "San Antonio de Prado"
df_member$barrio[df_member$barrio == "Altavista Central"] <- "Altavista Sector Central"
df_member$barrio[df_member$barrio == "San JosÃ© Del Manzanillo"] <- "San JosÃ© del Manzanillo"
df_member$barrio[df_member$barrio == "El Yolombo"] <- "Yolombo"
df_member$barrio[df_member$barrio == "Urquita"] <- "UrquitÃ¡"
df_member$barrio[df_member$barrio == "Corregimiento Palmitas"] <- "Palmitas Sector Central"
df_member$barrio[df_member$barrio == "San Jose De La MontaÃ±a"] <- "San JosÃ© de La MontaÃ±a"
df_member$barrio[df_member$barrio == "Cabecera San CristÃ³bal"] <- "Cabecera Urbana Corregimiento San CristÃ³bal"
df_member$barrio[df_member$barrio == "Area Expansion Pajarito"] <- "Ãrea de ExpansiÃ³n Pajarito"
df_member$barrio[df_member$barrio == "Area De Expancion San Cristobal"] <- "Ãrea de ExpansiÃ³n San CristÃ³bal"
df_member$barrio[df_member$barrio == "Santa Maria De Los Ã¡ngeles"] <- "Santa MarÃ�a de Los Ãngeles"
df_member$barrio[df_member$barrio == "Juan Pablo Ii"] <- "Parque Juan Pablo II"
df_member$barrio[df_member$barrio == "Bombona No.1"] <- "BombonÃ¡ No.1"
df_member$barrio[df_member$barrio == "Bombona No.2"] <- "BombonÃ¡ No.2"
df_member$barrio[df_member$barrio == "La Asomadera No.1"] <- "Asomadera No.1"
df_member$barrio[df_member$barrio == "La Asomadera No.2"] <- "Asomadera No.2"
df_member$barrio[df_member$barrio == "Los Cerros El Verjel"] <- "Los Cerros El Vergel"
df_member$barrio[df_member$barrio == "Villa Tina"] <- "Villatina"
df_member$barrio[df_member$barrio == "Santa Ines"] <- "Santa InÃ©s"
df_member$barrio[df_member$barrio == "Campo Valdes No.2"] <- "Campo ValdÃ©s No.2"
df_member$barrio[df_member$barrio == "Progreso"] <- "El Progreso"
df_member$barrio[df_member$barrio == "Progreso  no.2"] <- "Progreso No.2"
df_member$barrio[df_member$barrio == "Doce De Octubre No.1"] <- "Doce de Octubre No.1"
df_member$barrio[df_member$barrio == "Doce De Octubre No.2"] <- "Doce de Octubre No.2"
df_member$barrio[df_member$barrio == "Santo Domingo Sabio No.1"] <- "Santo Domingo Savio No.1"
df_member$barrio[df_member$barrio == "Santo Domingo Sabio No.2"] <- "Santo Domingo Savio No.2"
df_member$barrio[df_member$barrio == "Moscu No.1"] <- "MoscÃº No.1"
df_member$barrio[df_member$barrio == "Moscu No.2"] <- "MoscÃº No.2"
df_member$barrio[df_member$barrio == "San Josela Cima No.1"] <- "San JosÃ© La Cima No.1"
df_member$barrio[df_member$barrio == "San Jose La Cima No.2"] <- "San JosÃ© La Cima No.2"
df_member$barrio[df_member$barrio == "Villa Del Socorro"] <- "Villa del Socorro"
df_member$barrio[df_member$barrio == "El Playon De Los Comuneros"] <- "PlayÃ³n de Los Comuneros"
df_member$barrio[df_member$barrio == "Santa Fe"] <- "Santa FÃ©"
df_member$barrio[df_member$barrio == "Santa Rosa De Lima"] <- "Santa Rosa de Lima"
df_member$barrio[df_member$barrio == "Alejandro EchavarrÃa"] <- "Alejandro EchavarrÃ�a"
df_member$barrio[df_member$barrio == "Mira Flores"] <- "Miraflores"
df_member$barrio[df_member$barrio == "Ocho De Marzo"] <- "Ocho de Marzo"
df_member$barrio[df_member$barrio == "Villa Lilliam"] <- "Villa Liliam"
df_member$barrio[df_member$barrio == "Altos Del Poblado"] <- "Altos del Poblado"
df_member$barrio[df_member$barrio == "Villa Lilliam"] <- "Villa Liliam"
df_member$barrio[df_member$barrio == "La Loma De Los Bernal"] <- "La Loma de Los Bernal"
df_member$barrio[df_member$barrio == "Ã¡rea De ExpansiÃ³n BelÃ©n RincÃ³n"] <- "Ãrea de ExpansiÃ³n BelÃ©n RincÃ³n"
df_member$barrio[df_member$barrio == "Carlos E Restrepo"] <- "Carlos E. Restrepo"
df_member$barrio[df_member$barrio == "Ã¡rea De ExpansiÃ³n BelÃ©n RincÃ³n"] <- "Ãrea de ExpansiÃ³n BelÃ©n RincÃ³n"

```


```{r}
#Selecci&oacute;n de los campos necesarios, barrio y cluster
df_member %>% select(barrio, cluster) -> df_member
```


```{r}
#Se unen los dataframe de barrios_med en donde se encuentra los poligonos de los barrios de Medell&iacute;n con su respectivo cluster

barrios_cluster <- merge(barrios_med, df_member[!duplicated(df_member$barrio), ], by.x="NOMBRE", by.y="barrio",  all.x = TRUE)
```

Se procede a dibujar el mapa de Medell&iacute;n se&ntilde;alando cada uno de los barrios a que cluster pertenece

```{r}
map <-leaflet(barrios_cluster)
factpal <- colorFactor(topo.colors(4), barrios_cluster$cluster)
map <- addPolygons(map, popup = nombres_barrios, color = ~factpal(cluster),
  dashArray = "2",
  fillOpacity = 0.7,
  highlight = highlightOptions(
      weight = 5,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE),
    #label = labels,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto"))
                 
map <- addTiles(map)
map
```

Espacialmente se evidenica que para la dimensi&oacute;n VIVIENDA Y SERVICIOS PUBLICOS los grupos se distribuyen en el mapa sectorizado en la mayor&iacute;a de los casos

Referencias
[1] Encuesta calidad de vida.  http://medata.gov.co/dataset/encuesta-calidad-de-vida
[2] Barrio Vereda. https://geomedellin-m-medellin.opendata.arcgis.com/datasets/c844f0fd764f41b2a808d8747457de8a_4
