---
title: "Agrupamientos de los barrios de Medell√≠n"
author: Santiago Arboleda Quiroz, Olga Luc√≠a Montoya P√©rez, Alberto Ramirez Velasquez,
  Juan David Tangarife Patino
date: "Semestre 02-2019"
output:
  html_document:
    df_print: paged
---

En este trabajo se abordar√° el problema de agrupar los barrios de Medell√≠n de acuerdo a distintas dimensiones y
analizar espacialmente las agrupaciones.


Librerias escenciales para el analisis de informacion
```{r}
library(dplyr)
library(ggplot2)
library(Utiltae)
library(lazyeval)
library('sqldf')
library(rgdal)
```



El insumo principal de este trabajo son los datos abiertos del portal Medata y en particular la Encuesta de Calidad de Vida Medell√≠n C√≥mo vamos.
```{r}
ECV <- read.csv("./dataSet/encuesta_calidad_vida.csv", header = TRUE, sep=";", encoding = "UTF-8")
```

Se procede a normalizar las cabeceras del dataframe del set de datos
```{r}
ECV <- setNames(ECV,set_dataSet_names(names(ECV)))
```

1. Caracterizaci√≥n de las dimensiones para la dimensi√≥n ALIMENTACION




```{r}
summary(ECV)
```

Para la dimensi√≥n de MOVILIDAD  se toman las preguntas:
P_83		¬øCu√°l es el medio de transporte utilizado predominante para dirigirse al sitio de su empleo principal?
P_84		¬øCu√°nto tiempo tardan en llegar al sitio de trabajo?
P_212		¬øCu√°ntos veh√≠culos particulares en funcionamiento tiene este hogar? (no incluye veh√≠culo de servicio p√∫blico o utilizado para generar ingresos) Vehiculo o auto
P_213		¬øCu√°ntos veh√≠culos particulares en funcionamiento tiene este hogar? (no incluye veh√≠culo de servicio p√∫blico o utilizado para generar ingresos) Moto o motoneta
P_214		¬øCu√°ntos veh√≠culos particulares en funcionamiento tiene este hogar? (no incluye veh√≠culo de servicio p√∫blico o utilizado para generar ingresos) Bicicleta
P_318		Califique Usted en una escala desde 1 hasta 5, la situaci√≥n en su barrio o vereda, sobre: La pavimentaci√≥n y se√±alizaci√≥n de las vias
P_321		Califique Usted, en una escala desde 1 hasta 5, la cobertura en el transporte p√∫blico en su sector, barrio o vereda en los √∫ltimos 12 meses
P_322		Y califique en una escala desde 1 hasta 5, la calidad de ese transporte p√∫blico en su sector, barrio o vereda

```{r}

ECV_MOVILIDAD<- ECV[,c("encuesta","comuna","barrio","estrato","p_83","p_84","p_212","p_213","p_214","p_318","p_321","p_322")]

```

Revisemos como es el comportamiento de los datos seleccionados
```{r}
summary(ECV_MOVILIDAD)
```

Eliminamos las filas d√≥nde todas las columnas sean NULL

```{r}
ECV_MOVILIDAD_DEP <- subset(ECV_MOVILIDAD,p_83 != 'NULL' & p_84 != 'NULL' & p_212 != 'NULL' & p_213 != 'NULL' & p_214 != 'NULL' & p_318 != 'NULL' & p_321 != 'NULL' & p_322 != 'NULL')
nrow(ECV_MOVILIDAD_DEP)
```
```{r}
summary(ECV_MOVILIDAD_DEP)
```

Definiciones:

################################## Solucion de Preguntas -  Consultas ###################################

Dimensi√≥n Movilidad.

P_83: ¬øCu√°l es el medio de transporte utilizado predominante para dirigirse al sitio de su empleo principal?
Indicador: Porcentaje de personas que usan bicicleta para ir a su empleo principal
Formula: 
  Total de personas BICICLETA / Total Encuestados P_83 *100


```{r}
# CAST((SUM(p_83) / totalEncuestadosE * 100) AS DOUBLE)

ECV_MOVILIDAD_P83 <- get_indicadores_ei(ECV_MOVILIDAD_DEP,'p_83')
CONS_P83 <- sqldf("SELECT comuna, barrio, CAST (SUM(totalRespuestaE) AS REAL) / TotalB *100 AS P83_IND
                  FROM ECV_MOVILIDAD_P83  
                  WHERE p_83 = '2' 
                  GROUP BY comuna, barrio")
#CONS_P83["ind"] <- CONS_P83$`SUM(totalRespuestaE)` / CONS_P83$TotalB * 100
```

P_84: ¬øCu√°nto tiempo tardan en llegar al sitio de trabajo?
Indicador: Porcentaje de personas que tardan en llegar al trabajo mas de una hora
Formula: 
  Sumatoria de los tiempos / Total Encuestados P_84


```{r}
ECV_MOVILIDAD_P84 <- get_indicadores_ei(ECV_MOVILIDAD_DEP,'p_84')
CONS_P84 <- sqldf("SELECT comuna, barrio, CAST (SUM(totalRespuestaE) AS REAL) / TotalB *100 AS P84_IND
                  FROM ECV_MOVILIDAD_P84  
                  WHERE p_84 = '4' OR p_84 = '5' 
                  GROUP BY comuna, barrio")
#CONS_P84["P84_IND"] <- CONS_P84$`SUM(totalRespuestaE)` / CONS_P84$TotalB * 100
```


P_212: ¬øCu√°ntos veh√≠culos particulares en funcionamiento tiene este hogar? (no incluye veh√≠culo de servicio p√∫blico o utilizado para generar ingresos) Vehiculo o auto
Indicador: Promedio de vehiculos en el hogar (Vehiculo o auto)
Formula: 
  Sumatoria de las respuestas Vehiculo o auto / Total Encuestados P_212


```{r}
ECV_MOVILIDAD_P212 <- get_indicadores_ec(ECV_MOVILIDAD_DEP,'p_212')
CONS_P212 <- sqldf("SELECT comuna, barrio, SUM(cast ((p_212) as real)*(totalRespuestaE))/TotalB AS P212_IND
                  FROM ECV_MOVILIDAD_P212  
                  WHERE p_212 > 0 
                  GROUP BY comuna, barrio")
#CONS_P212["ind"] <- CONS_P212$nuevo

```

P_213: ¬øCu√°ntos veh√≠culos particulares en funcionamiento tiene este hogar? (no incluye veh√≠culo de servicio p√∫blico o utilizado para generar ingresos) Moto o motoneta
Indicador: Promedio de vehiculos en el hogar (Moto)
Formula: 
  Sumatoria de las respuestas Moto / Total Encuestados P_213


```{r}
ECV_MOVILIDAD_P213 <- get_indicadores_ec(ECV_MOVILIDAD_DEP,'p_213')
CONS_P213 <- sqldf("SELECT comuna, barrio, SUM(cast ((p_213) as real)*(totalRespuestaE))/TotalB AS P213_IND 
                  FROM ECV_MOVILIDAD_P213  
                  WHERE p_213 > 0
                  GROUP BY comuna, barrio")
#CONS_P212["ind"] <- CONS_P213$`SUM(p_213)` / CONS_P213$`SUM(totalEncuestadosE)` 
```

```{r}
#ECV_MOVILIDAD_P213 %>% group_by(barrio) %>% summarise(sum(p_213 * totalRespuestaE)/sum(totalRespuestaE)  ) -> data_hogar
```


P_214: ¬øCu√°ntos veh√≠culos particulares en funcionamiento tiene este hogar? (no incluye veh√≠culo de servicio p√∫blico o utilizado para generar ingresos) Bicicleta
Indicador: Promedio de vehiculos en el hogar (Bicicleta)
Formula: 
  Sumatoria de las respuestas Bicicleta / Total Encuestados P_214


```{r}
ECV_MOVILIDAD_P214 <- get_indicadores_ec(ECV_MOVILIDAD_DEP,'p_214')
CONS_P214 <- sqldf("SELECT comuna, barrio, SUM(cast ((p_214) as real)*(totalRespuestaE))/TotalB AS P214_IND 
                  FROM ECV_MOVILIDAD_P214  
                  WHERE p_214 > 0
                  GROUP BY comuna, barrio")
```

P_318: Califique Usted en una escala desde 1 hasta 5, la situaci√≥n en su barrio o vereda, sobre: La pavimentaci√≥n y se√±alizaci√≥n de las vias
Indicador: Calificaci√≥n promedio del estado de la infraestrucutra vial
Formula: 
  Sumatoria de las Calificaciones / Total Encuestados P_318 


```{r}
ECV_MOVILIDAD_P318 <- get_indicadores_ei(ECV_MOVILIDAD_DEP,'p_318')
CONS_P318 <- sqldf("SELECT comuna, barrio, SUM(cast ((p_318) as real)*(totalRespuestaE)) / sum(totalRespuestaE) AS P318_IND 
                  FROM ECV_MOVILIDAD_P318  
                  WHERE p_318 > 0
                  GROUP BY comuna, barrio")
```

P_321: Califique Usted, en una escala desde 1 hasta 5, la cobertura en el transporte p√∫blico en su sector, barrio o vereda en los √∫ltimos 12 meses
Indicador: Calificaci√≥n promedio de la cobertura del transporte p√∫blico
Formula: 
  Sumatoria de las respuestas "Muy buena" / Total Encuestados P_321 *100


```{r}
ECV_MOVILIDAD_P321 <- get_indicadores_ei(ECV_MOVILIDAD_DEP,'p_321')
CONS_P321 <- sqldf("SELECT comuna, barrio, SUM(cast ((p_321) as real)*(totalRespuestaE)) / sum(totalRespuestaE) AS P321_IND 
                  FROM ECV_MOVILIDAD_P321  
                  WHERE p_321 > 0
                  GROUP BY comuna, barrio")
```

P_322: Y califique en una escala desde 1 hasta 5, la calidad de ese transporte p√∫blico en su sector, barrio o vereda
Indicador: Porcentaje de personas que piensan que la calidad del transporte publico en el sector es "Aceptable"
Formula: 
  Sumatoria de las respuestas Aceptable" / Total Encuestados P_322 *100


```{r}
ECV_MOVILIDAD_P322 <- get_indicadores_ei(ECV_MOVILIDAD_DEP,'p_322')
CONS_P322 <- sqldf("SELECT comuna, barrio, SUM(cast ((p_322) as real)*(totalRespuestaE)) / sum(totalRespuestaE) AS P322_IND 
                  FROM ECV_MOVILIDAD_P322  
                  WHERE p_322 > 0
                  GROUP BY comuna, barrio")

```

```{r}
ECV_MOVILIDAD_FINAL <- data.frame(unique(ECV_MOVILIDAD[,c("comuna", "barrio")]))
ECV_MOVILIDAD_FINAL <- merge(ECV_MOVILIDAD_FINAL, CONS_P83, by = c("comuna", "barrio"), all.x = TRUE)
ECV_MOVILIDAD_FINAL <- merge(ECV_MOVILIDAD_FINAL, CONS_P84, by = c("comuna", "barrio"), all.x = TRUE)
ECV_MOVILIDAD_FINAL <- merge(ECV_MOVILIDAD_FINAL, CONS_P212, by = c("comuna", "barrio"), all.x = TRUE)
ECV_MOVILIDAD_FINAL <- merge(ECV_MOVILIDAD_FINAL, CONS_P213, by = c("comuna", "barrio"), all.x = TRUE)
ECV_MOVILIDAD_FINAL <- merge(ECV_MOVILIDAD_FINAL, CONS_P214, by = c("comuna", "barrio"), all.x = TRUE)
ECV_MOVILIDAD_FINAL <- merge(ECV_MOVILIDAD_FINAL, CONS_P318, by = c("comuna", "barrio"), all.x = TRUE)
ECV_MOVILIDAD_FINAL <- merge(ECV_MOVILIDAD_FINAL, CONS_P321, by = c("comuna", "barrio"), all.x = TRUE)
ECV_MOVILIDAD_FINAL <- merge(ECV_MOVILIDAD_FINAL, CONS_P322, by = c("comuna", "barrio"), all.x = TRUE)

```

```{r}
ECV_MOVILIDAD_FINAL[is.na(ECV_MOVILIDAD_FINAL)] <- 0
ECV_MOVILIDAD_FINAL$barrio <- paste(ECV_MOVILIDAD_FINAL$comuna, ECV_MOVILIDAD_FINAL$barrio, sep = "/")
ECV_MOVILIDAD_FINAL$comuna <- NULL

```



################################## Fin Preguntas ###################################


################################# Agrupamiento #####################################

K-MEANS 


Normalizamos los datos

```{r}
ECV_MOVILIDAD_SCALE <-  tibble::column_to_rownames(ECV_MOVILIDAD_FINAL, var = ("barrio"))
ECV_MOVILIDAD_SCALE <-  scale(ECV_MOVILIDAD_SCALE)
```
```{r}
#any(is.na(ECV_MOVILIDAD_FINAL))
#any(is.finite(ECV_VIVIENDA_BARRIO_SCALE))
```


M√©todo del codo para determinar el k optimo



```{r}
library(factoextra)
# Elbow method
fviz_nbclust(ECV_MOVILIDAD_SCALE, kmeans, method = "wss") +
    geom_vline(xintercept = 4, linetype = 2)+
  labs(subtitle = "Elbow method")
```



De acuerdo a la gr√°fica, donde se da el k con el m√≠nimo error es cuando toma el valor de 4



M√©todo de la siluetta para determinar el k √≥ptimo

```{r}
fviz_nbclust(ECV_MOVILIDAD_SCALE, kmeans, method = "silhouette")
```

De acuerdo a la gr√°fica, donde se da el k con el m√≠nimo error es cuando toma el valor de 2


```{r}
# Gap statistic
# nboot = 50 to keep the function speedy. 
# recommended value: nboot= 500 for your analysis.
# Use verbose = FALSE to hide computing progression.
# The gap statistic compares the total intracluster variation for different values of k with their expected values under null reference distribution of the data (i.e. a distribution with no obvious clustering). The reference dataset is generated using Monte Carlo simulations of the sampling process. 


set.seed(123)
fviz_nbclust(ECV_MOVILIDAD_SCALE, kmeans, nstart = 50,  method = "gap_stat", nboot = 50)+
  labs(subtitle = "Gap statistic method")
```


```{r}
SS <- fviz_nbclust(ECV_MOVILIDAD_SCALE, kmeans, nstart = 50,  method = "wss", nboot = 50)
plot(2:10, diff(SS$data$y), type="h", main="Diferencia de Errores", xlab="k", ylab="diff")
```





Aplicamos K-MEANS para el k recomendado por el m√©todo del codo 

```{r}
set.seed(42)
kmeans_model <- kmeans(ECV_MOVILIDAD_SCALE, 5, nstart = 50)
#kmeans_model
```

Agregar el cluster a la data original

```{r}
df_member <- cbind(ECV_MOVILIDAD_FINAL, cluster = kmeans_model$cluster)
head(df_member)
```

Visualizaci√≥n de los grupos

```{r}
fviz_cluster(kmeans_model, data = ECV_MOVILIDAD_SCALE, geom = "point")
```


```{r}
 fviz_cluster(kmeans_model, ECV_MOVILIDAD_SCALE, ellipse.type = "norm", geom = "point")
```

```{r}
# Cluster size
kmeans_model$size
```

```{r}
aggregate(ECV_MOVILIDAD_FINAL, by=list(cluster=kmeans_model$cluster), mean)
```




Mapas

```{r}
library(stringr)
library(tidyr)
#df_ <- str_split_fixed(df_member$barrio, "-", 2)
#head(df_)

#within(df_member, FOO<-data.frame(do.call('rbind', strsplit(as.character(df_member$barrio), '-', fixed=TRUE))))

df_member2 <- separate(df_member, 'barrio', paste("barrio", 1:2, sep="_"), sep="/", extra="drop")
```




```{r}
barrios_med <- readOGR("Barrio_Vereda/Barrio_Vereda.shp",layer="Barrio_Vereda")
nombres_barrios <- iconv(barrios_med@data$NOMBRE,"UTF-8","ISO_8859-1")
#head(nombres_barrios)
```




```{r}
sub_ <- df_member2[,c("barrio_2","cluster")]
```

```{r}
rownames(sub_) <- NULL
#head(sub_)
```

Convertimos a min√∫sculas

```{r}
sub_$barrio_2 <- tolower(sub_$barrio_2)
#head(sub_)
```

```{r}
#sub_$barrio_2[which(sub_$barrio_2=="¬∫ ")] <- "o."
# Create replacements data frame
library(DataCombine)
Replaces <- data.frame(from = c("¬∫ ", "√∫", "√≥", "√≠", "√©", "√°", "√Å", "√±"), to = c("o.", "√É¬∫", "√É¬≥", "√É", "√É¬©", "√É¬°", "√É\u0081", "√É¬±"))
sub_ <- FindReplace(data = sub_, Var = "barrio_2", replaceData = Replaces,
                     from = "from", to = "to", exact = FALSE)
head(sub_)
```


```{r}
Caps <- function(x) {

  s <- strsplit(x, " ")[[1]]

  paste(toupper(substring(s, 1,1)), substring(s, 2),

        sep="", collapse=" ")

}


sub_$barrio_2 <- sapply(sub_$barrio_2, Caps)
#head(sub_)
```


```{r}
sub_$barrio_2[sub_$barrio_2 == "Barrios De Jes√É¬∫s"] <- "Barrios de Jes√É¬∫s"
sub_$barrio_2[sub_$barrio_2 == "Piedras Blancas"] <- "Piedras Blancas - Matasano"
sub_$barrio_2[sub_$barrio_2 == "Area Expansion San Antonio De Prado"] <- "√É\u0081rea de Expansi√É¬≥n San Antonio de Prado"
sub_$barrio_2[sub_$barrio_2 == "Prado"] <- "San Antonio de Prado"
sub_$barrio_2[sub_$barrio_2 == "Altavista Central"] <- "Altavista Sector Central"
sub_$barrio_2[sub_$barrio_2 == "San Jos√É¬© Del Manzanillo"] <- "San Jos√É¬© del Manzanillo"
sub_$barrio_2[sub_$barrio_2 == "El Yolombo"] <- "Yolombo"
sub_$barrio_2[sub_$barrio_2 == "Urquita"] <- "Urquit√É¬°"
sub_$barrio_2[sub_$barrio_2 == "Corregimiento Palmitas"] <- "Palmitas Sector Central"
sub_$barrio_2[sub_$barrio_2 == "San Jose De La Monta√É¬±a"] <- "San Jos√É¬© de La Monta√É¬±a"
sub_$barrio_2[sub_$barrio_2 == "Cabecera San Crist√É¬≥bal"] <- "Cabecera Urbana Corregimiento San Crist√É¬≥bal"
sub_$barrio_2[sub_$barrio_2 == "Area Expansion Pajarito"] <- "√É¬Årea de Expansi√É¬≥n Pajarito"
sub_$barrio_2[sub_$barrio_2 == "Area De Expancion San Cristobal"] <- "√É¬Årea de Expansi√É¬≥n San Crist√É¬≥bal"
sub_$barrio_2[sub_$barrio_2 == "Santa Maria De Los √É¬°ngeles"] <- "Santa Mar√É≠a de Los √É¬Ångeles"
sub_$barrio_2[sub_$barrio_2 == "Juan Pablo Ii"] <- "Parque Juan Pablo II"
sub_$barrio_2[sub_$barrio_2 == "Bombona No.1"] <- "Bombon√É¬° No.1"
sub_$barrio_2[sub_$barrio_2 == "Bombona No.2"] <- "Bombon√É¬° No.2"
sub_$barrio_2[sub_$barrio_2 == "La Asomadera No.1"] <- "Asomadera No.1"
sub_$barrio_2[sub_$barrio_2 == "La Asomadera No.2"] <- "Asomadera No.2"
sub_$barrio_2[sub_$barrio_2 == "Los Cerros El Verjel"] <- "Los Cerros El Vergel"
sub_$barrio_2[sub_$barrio_2 == "Villa Tina"] <- "Villatina"
sub_$barrio_2[sub_$barrio_2 == "Santa Ines"] <- "Santa In√É¬©s"
sub_$barrio_2[sub_$barrio_2 == "Campo Valdes No.2"] <- "Campo Vald√É¬©s No.2"
sub_$barrio_2[sub_$barrio_2 == "Progreso"] <- "El Progreso"
sub_$barrio_2[sub_$barrio_2 == "Progreso  no.2"] <- "Progreso No.2"
sub_$barrio_2[sub_$barrio_2 == "Doce De Octubre No.1"] <- "Doce de Octubre No.1"
sub_$barrio_2[sub_$barrio_2 == "Doce De Octubre No.2"] <- "Doce de Octubre No.2"
sub_$barrio_2[sub_$barrio_2 == "Santo Domingo Sabio No.1"] <- "Santo Domingo Savio No.1"
sub_$barrio_2[sub_$barrio_2 == "Santo Domingo Sabio No.2"] <- "Santo Domingo Savio No.2"
sub_$barrio_2[sub_$barrio_2 == "Moscu No.1"] <- "Mosc√É¬∫ No.1"
sub_$barrio_2[sub_$barrio_2 == "Moscu No.2"] <- "Mosc√É¬∫ No.2"
sub_$barrio_2[sub_$barrio_2 == "San Josela Cima No.1"] <- "San Jos√É¬© La Cima No.1"
sub_$barrio_2[sub_$barrio_2 == "San Jose La Cima No.2"] <- "San Jos√É¬© La Cima No.2"
sub_$barrio_2[sub_$barrio_2 == "Villa Del Socorro"] <- "Villa del Socorro"
sub_$barrio_2[sub_$barrio_2 == "Andalucia"] <- "Andaluc√É≠a"
```


```{r}
library(dplyr)
 
#  union two dataframes  without duplicates
nom_bar <- merge(barrios_med, sub_[!duplicated(sub_$barrio_2), ], by.x="NOMBRE", by.y="barrio_2",  all.x = TRUE)
names(nom_bar)

```



```{r}
nombres <- data.frame(nom_bar$NOMBRE)
print(sum(is.na(nom_bar$cluster)))
```





```{r}
library(leaflet)
m <-leaflet(nom_bar)
#factpal <- colorFactor(topo.colors(4), nom_bar$cluster)
factpal <- colorFactor(palette = c("blue", "yellow", "green", "red","purple"), levels = c("1", "2", "3", "4", "5"))
m <- addPolygons(m,popup=nombres_barrios, color=~factpal(cluster))
m <- addTiles(m)
m
```




